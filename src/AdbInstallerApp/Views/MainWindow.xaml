<Window x:Class="AdbInstallerApp.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:AdbInstallerApp.ViewModels"
        xmlns:converters="clr-namespace:AdbInstallerApp.Converters"
        mc:Ignorable="d"
        Title="ADB Installer App" Height="800" Width="1400"
        Background="{StaticResource BackgroundBrush}"
        WindowStartupLocation="CenterScreen">
    
    <Window.Resources>
        <converters:ModuleToVisibilityConverter x:Key="ModuleToVisibilityConverter"/>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:StringToBooleanConverter x:Key="StringToBooleanConverter"/>
        <converters:IntToVisibilityConverter x:Key="IntToVisibilityConverter"/>
        <converters:StringToVisibilityConverter x:Key="StringToVisibilityConverter"/>
        <converters:MultiValueConverter x:Key="MultiValueConverter"/>
        <converters:IndexToNumberConverter x:Key="IndexToNumberConverter"/>
    </Window.Resources>
    
    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Header Bar -->
        <Border Grid.Row="0" 
                Padding="20,15">
                    <Border.Background>
                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                            <GradientStop Color="#764ba2" Offset="0"/>
                            <GradientStop Color="#667eea" Offset="1"/>
                        </LinearGradientBrush>
                    </Border.Background>
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- Logo and Title -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <TextBlock Text="📋" FontSize="24" VerticalAlignment="Center" Margin="0,0,12,0"/>
                    <TextBlock Text="ADB Installer App - APK Management and Installation" 
                               FontSize="18" FontWeight="Bold" 
                               Foreground="White" VerticalAlignment="Center"/>
                </StackPanel>
                
                <!-- Status Indicators -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Right">
                    <Border Background="White" CornerRadius="4" Padding="8,4" Margin="0,0,8,0">
                        <TextBlock Text="{Binding DevicesCountText, FallbackValue='0 Devices'}" 
                                   Foreground="#2196F3" FontWeight="SemiBold"/>
                    </Border>
                    <Border Background="White" CornerRadius="4" Padding="8,4" Margin="0,0,8,0">
                        <TextBlock Text="{Binding ApkFilesCountText, FallbackValue='0 APKs'}" 
                                   Foreground="#2196F3" FontWeight="SemiBold"/>
                    </Border>
                    <Border Background="White" CornerRadius="4" Padding="8,4">
                        <TextBlock Text="Ready" Foreground="#2196F3" FontWeight="SemiBold"/>
                    </Border>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Main Content Area -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250" MinWidth="200" MaxWidth="350"/>
                <ColumnDefinition Width="*" MinWidth="600"/>
            </Grid.ColumnDefinitions>
            
            <!-- Left Navigation Panel -->
            <Border Grid.Column="0" 
                    Background="White" 
                    BorderBrush="{StaticResource DividerBrush}" 
                    BorderThickness="0,0,1,0">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="0,20">
                        <!-- Navigation Header -->
                        <TextBlock Text="Navigation" 
                                   FontSize="16" FontWeight="Bold" 
                                   Foreground="#666" Margin="20,0,20,16"/>
                        
                        <!-- Core Modules -->
                        <TextBlock Text="Core Modules" 
                                   FontSize="14" FontWeight="SemiBold" 
                                   Foreground="#888" Margin="20,0,20,8"/>
                        
                        <Button Content="📱 Devices" 
                                Style="{StaticResource NavigationButtonStyle}"
                                Command="{Binding NavigateToDevicesCommand}"
                                Tag="Devices"/>
                        
                        <Button Content="📦 APK Files" 
                                Style="{StaticResource NavigationButtonStyle}"
                                Command="{Binding NavigateToApkFilesCommand}"
                                Tag="ApkFiles"/>
                        
                        <Button Content="⏳ Install Queue" 
                                Style="{StaticResource NavigationButtonStyle}"
                                Command="{Binding NavigateToInstallQueueCommand}"
                                Tag="InstallQueue"/>
                        
                        <Button Content="🚀 Multi-Group Install" 
                                Style="{StaticResource NavigationButtonStyle}"
                                Command="{Binding NavigateToMultiGroupInstallCommand}"
                                Tag="MultiGroupInstall"
                                ToolTip="Install multiple APK groups sequentially with progress tracking"/>
                        
                        <!-- Tools -->
                        <TextBlock Text="Tools" 
                                   FontSize="14" FontWeight="SemiBold" 
                                   Foreground="#888" Margin="20,16,20,8"/>
                        
                        <Button Content="🔧 Device Tools" 
                                Style="{StaticResource NavigationButtonStyle}"
                                Command="{Binding NavigateToDeviceToolsCommand}"
                                Tag="DeviceTools"/>
                        
                        <Button Content="📡 Wi-Fi ADB" 
                                Style="{StaticResource NavigationButtonStyle}"
                                Command="{Binding NavigateToWifiAdbCommand}"
                                Tag="WifiAdb"/>
                        
                        <Button Content="📸 Screenshots" 
                                Style="{StaticResource NavigationButtonStyle}"
                                Command="{Binding NavigateToScreenshotsCommand}"
                                Tag="Screenshots"/>
                        
                        <!-- Analysis -->
                        <TextBlock Text="Analysis" 
                                   FontSize="14" FontWeight="SemiBold" 
                                   Foreground="#888" Margin="20,16,20,8"/>
                        
                        <Button Content="📊 Logcat" 
                                Style="{StaticResource NavigationButtonStyle}"
                                Command="{Binding NavigateToLogcatCommand}"
                                Tag="Logcat"/>
                        
                        <Button Content="📋 Installed Apps" 
                                Style="{StaticResource NavigationButtonStyle}"
                                Command="{Binding NavigateToInstalledAppsCommand}"
                                Tag="InstalledApps"/>
                        
                        <Button Content="📈 Reports" 
                                Style="{StaticResource NavigationButtonStyle}"
                                Command="{Binding NavigateToReportsCommand}"
                                Tag="Reports"/>
                        
                        <!-- System -->
                        <TextBlock Text="System" 
                                   FontSize="14" FontWeight="SemiBold" 
                                   Foreground="#888" Margin="20,16,20,8"/>
                        
                        <Button Content="⚙️ Settings" 
                                Style="{StaticResource NavigationButtonStyle}"
                                Command="{Binding NavigateToSettingsCommand}"
                                Tag="Settings"/>
                    </StackPanel>
                </ScrollViewer>
            </Border>
            
            <!-- Main Content Area -->
            <Border Grid.Column="1" 
                    Background="#F8F9FA" 
                    Padding="30">
                <Grid>
                    <!-- Welcome Screen (Default) -->
                    <Grid x:Name="WelcomeContent" 
                          Visibility="{Binding CurrentModule, Converter={StaticResource ModuleToVisibilityConverter}, ConverterParameter='Welcome'}">
                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                            <TextBlock Text="Welcome to ADB Installer App" 
                                       FontSize="32" FontWeight="Bold" 
                                       Foreground="#333" HorizontalAlignment="Center" Margin="0,0,0,16"/>
                            <TextBlock Text="Select a module from the navigation panel to get started." 
                                       FontSize="18" Foreground="#666" HorizontalAlignment="Center" Margin="0,0,0,32"/>
                            <TextBlock Text="🚀" FontSize="80" HorizontalAlignment="Center" Margin="0,0,0,32"/>
                            <TextBlock Text="No module selected" 
                                       FontSize="20" FontWeight="Bold" 
                                       Foreground="#999" HorizontalAlignment="Center" Margin="0,0,0,16"/>
                            <TextBlock Text="Choose a module from the left navigation panel to begin working with devices, APK files, or installation tasks." 
                                       FontSize="16" Foreground="#666" HorizontalAlignment="Center" 
                                       TextWrapping="Wrap" MaxWidth="500"/>
                        </StackPanel>
                    </Grid>
                
                <!-- Devices Module -->
                <Grid x:Name="DevicesContent" 
                      Visibility="{Binding CurrentModule, Converter={StaticResource ModuleToVisibilityConverter}, ConverterParameter='Devices'}">
                    <StackPanel>
                         <!-- Header Section -->
                         <Border CornerRadius="12" Padding="12" Margin="0,0,0,12" 
                                 Effect="{StaticResource CardShadow}">
                             <Border.Background>
                                 <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                     <GradientStop Color="#764ba2" Offset="0"/>
                                     <GradientStop Color="#667eea" Offset="1"/>
                                 </LinearGradientBrush>
                             </Border.Background>
                             <Grid>
                                 <Grid.ColumnDefinitions>
                                     <ColumnDefinition Width="*"/>
                                     <ColumnDefinition Width="Auto"/>
                                 </Grid.ColumnDefinitions>
                                 
                                 <StackPanel Grid.Column="0">
                                     <TextBlock Text="📱 Connected Devices" 
                                                FontSize="20" FontWeight="Bold" 
                                                Foreground="White" Margin="0,0,0,8"/>
                                     <TextBlock Text="Manage and monitor your Android devices" 
                                                FontSize="12" Foreground="White" Opacity="0.5"/>
                                 </StackPanel>
                             </Grid>
                         </Border>
                         <!-- Device Controls -->
                         <Grid Margin="0,0,0,6" Effect="{StaticResource CardShadow}">
                             <Grid.ColumnDefinitions>
                                 <ColumnDefinition Width="Auto"/>
                                 <ColumnDefinition Width="*"/>
                                 <ColumnDefinition Width="Auto"/>
                                 <ColumnDefinition Width="Auto"/>
                             </Grid.ColumnDefinitions>
                             
                             <!-- Select All Button -->
                             <Button Grid.Column="0" Content="☑️ Select All" 
                                     Style="{StaticResource ModernButtonStyle}"
                                     Command="{Binding SelectAllDevicesCommand}"
                                     FontSize="12" Padding="8,5" Margin="4,0,6,6"/>
                             
                             <!-- Spacer -->
                             <Grid Grid.Column="1"/>
                             
                             <!-- USB Debug Checklist Button -->
                             <Button Grid.Column="2" Content="🔧 USB Debug Checklist" 
                                     Style="{StaticResource ModernButtonStyle}"
                                     Command="{Binding ShowUsbDebugChecklistCommand}"
                                     Margin="0,0,8,6"
                                     FontSize="12" Padding="8,5"
                                     ToolTip="Show troubleshooting steps for USB debugging issues"/>
                             
                             <!-- Selection Count Badge -->
                             <Border Grid.Column="3" Background="#E8F5E8" CornerRadius="8" Padding="12,12" 
                                     VerticalAlignment="Center" Margin="0,0,6,6">
                                 <TextBlock Text="{Binding SelectedDevicesCountText, FallbackValue='No devices selected'}" 
                                            Foreground="#2E7D32" FontSize="14" FontWeight="Medium"/>
                             </Border>
                        </Grid>
                         <!-- Devices DataGrid -->
                         <DataGrid x:Name="DevicesDataGrid"
                                   ItemsSource="{Binding Devices}" 
                                   AutoGenerateColumns="False" 
                                   CanUserAddRows="False"
                                   CanUserDeleteRows="False"
                                   CanUserResizeRows="False"
                                   GridLinesVisibility="None"
                                   HeadersVisibility="Column"
                                   SelectionMode="Single"
                                   Background="White"
                                   RowBackground="White"
                                   AlternatingRowBackground="#F8F9FA"
                                   RowHeight="36"
                                   FontSize="12"
                                   FontFamily="{StaticResource SrotoneRegular}"
                                   BorderThickness="0"
                                   BorderBrush="#E0E0E0"
                                   CanUserSortColumns="True"
                                   CanUserReorderColumns="False"
                                   IsReadOnly="False"
                                   EnableRowVirtualization="True"
                                   EnableColumnVirtualization="True"
                                   VirtualizingStackPanel.IsVirtualizing="True"
                                   ScrollViewer.CanContentScroll="True"
                                   ScrollViewer.VerticalScrollBarVisibility="Auto"
                                   ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                   ScrollViewer.PanningMode="VerticalOnly"
                                   MaxHeight="400"
                                   IsSynchronizedWithCurrentItem="False"
                                   IsTextSearchEnabled="False"
                                   ColumnHeaderHeight="36">
                                   <DataGrid.RowStyle>
                                       <Style TargetType="DataGridRow">
                                           <Setter Property="ToolTip">
                                               <Setter.Value>
                                                   <ToolTip>
                                                       <StackPanel MaxWidth="400">
                                                           <TextBlock Text="{Binding DisplayName}" FontWeight="Bold" FontSize="14" Margin="0,0,0,8"/>
                                                           <TextBlock Text="{Binding DeviceInfo}" Margin="0,0,0,4"/>
                                                           <TextBlock Text="{Binding HardwareSummary}" Margin="0,0,0,4"/>
                                                           <TextBlock Text="{Binding ScreenInfo}" Margin="0,0,0,4"/>
                                                           <TextBlock Text="{Binding BatteryInfo}" Margin="0,0,0,4"/>
                                                           <TextBlock Text="{Binding NetworkInfo}" Margin="0,0,0,4"/>
                                                           <TextBlock Text="{Binding PackageSummary}" Margin="0,0,0,4"/>
                                                           <TextBlock Text="{Binding ConnectionDiagnosis}" Margin="0,0,0,4"/>
                                                           <TextBlock Text="{Binding LastUpdated}" FontStyle="Italic" Opacity="0.7" Margin="0,8,0,0"/>
                                                       </StackPanel>
                                                   </ToolTip>
                                               </Setter.Value>
                                           </Setter>
                                       </Style>
                                   </DataGrid.RowStyle>
                             <DataGrid.Resources>
                                 <!-- Center alignment style for all cells -->
                                 <Style x:Key="CenterAlignedCellStyle" TargetType="DataGridCell">
                                     <Setter Property="BorderBrush" Value="#F5F5F5"/>
                                     <Setter Property="BorderThickness" Value="0,0,0,1"/>
                                     <Setter Property="Template">
                                         <Setter.Value>
                                             <ControlTemplate TargetType="DataGridCell">
                                                 <Border BorderBrush="{TemplateBinding BorderBrush}" 
                                                         BorderThickness="{TemplateBinding BorderThickness}"
                                                         Background="{TemplateBinding Background}">
                                                     <ContentPresenter HorizontalAlignment="Center" 
                                                                     VerticalAlignment="Center" 
                                                                     Margin="2"/>
                                                 </Border>
                                             </ControlTemplate>
                                         </Setter.Value>
                                     </Setter>
                                 </Style>
                                 
                                 <!-- Left alignment style for device name -->
                                 <Style x:Key="LeftAlignedCellStyle" TargetType="DataGridCell">
                                     <Setter Property="FontFamily" Value="{StaticResource SrotoneRegular}"/>
                                     <Setter Property="BorderBrush" Value="#F5F5F5"/>
                                     <Setter Property="BorderThickness" Value="0,0,0,1"/>
                                     <Setter Property="Template">
                                         <Setter.Value>
                                             <ControlTemplate TargetType="DataGridCell">
                                                 <Border BorderBrush="{TemplateBinding BorderBrush}" 
                                                         BorderThickness="{TemplateBinding BorderThickness}" 
                                                         Background="{TemplateBinding Background}">
                                                     <ContentPresenter HorizontalAlignment="Left" 
                                                                     VerticalAlignment="Center" 
                                                                     Margin="2"/>
                                                 </Border>
                                             </ControlTemplate>
                                         </Setter.Value>
                                     </Setter>
                                 </Style>
                                 
                                 <!-- Center alignment style for headers -->
                                 <Style x:Key="CenterAlignedHeaderStyle" TargetType="DataGridColumnHeader">
                                     <Setter Property="HorizontalContentAlignment" Value="Center"/>
                                     <Setter Property="VerticalContentAlignment" Value="Center"/>
                                     <Setter Property="FontWeight" Value="SemiBold"/>
                                     <Setter Property="FontSize" Value="13"/>
                                     <Setter Property="Foreground" Value="#333"/>
                                 </Style>
                                 
                                 <!-- Special style for checkbox column to center the checkbox -->
                                 <Style x:Key="CenterAlignedCheckBoxColumnStyle" TargetType="DataGridCell">
                                    <Setter Property="BorderBrush" Value="#F5F5F5"/>
                                    <Setter Property="BorderThickness" Value="0,0,0,1"/>
                                    <Setter Property="FontWeight" Value="Medium"/>
                                    <Setter Property="FontSize" Value="16"/>
                                    <Setter Property="Template">
                                         <Setter.Value>
                                             <ControlTemplate TargetType="DataGridCell">
                                                 <Border BorderBrush="{TemplateBinding BorderBrush}" 
                                                         BorderThickness="{TemplateBinding BorderThickness}" 
                                                         Background="{TemplateBinding Background}">
                                                     <ContentPresenter HorizontalAlignment="Center" 
                                                                     VerticalAlignment="Center" 
                                                                     Margin="2"/>
                                                 </Border>
                                             </ControlTemplate>
                                         </Setter.Value>
                                     </Setter>
                                 </Style>
                             </DataGrid.Resources>
                             
                             <DataGrid.Columns>
                                 <!-- CheckBox Column -->
                                 <DataGridCheckBoxColumn Binding="{Binding IsSelected, UpdateSourceTrigger=PropertyChanged}" 
                                                         Header="✓" 
                                                         Width="50"
                                                         HeaderStyle="{StaticResource CenterAlignedHeaderStyle}"
                                                         CellStyle="{StaticResource CenterAlignedCheckBoxColumnStyle}"/>
                                 
                                 <!-- Connection Status Column -->
                                 <DataGridTextColumn Binding="{Binding ConnectionStatus, Mode=OneWay}" 
                                                     Header="Status" 
                                                     Width="80" 
                                                     MinWidth="80" 
                                                     MaxWidth="120" 
                                                     IsReadOnly="True"
                                                     HeaderStyle="{StaticResource CenterAlignedHeaderStyle}"
                                                     CellStyle="{StaticResource CenterAlignedCellStyle}">
                                     <DataGridTextColumn.ElementStyle>
                                         <Style TargetType="TextBlock">
                                             <Style.Triggers>
                                                 <DataTrigger Binding="{Binding ConnectionStatus}" Value="Ready">
                                                     <Setter Property="Foreground" Value="#4CAF50"/>
                                                     <Setter Property="FontWeight" Value="Bold"/>
                                                     <Setter Property="FontSize" Value="14"/>
                                                     <Setter Property="HorizontalAlignment" Value="Center"/>
                                                     <Setter Property="VerticalAlignment" Value="Center"/>
                                                     <Setter Property="Margin" Value="2"/>
                                                 </DataTrigger>
                                                 <DataTrigger Binding="{Binding ConnectionStatus}" Value="Offline">
                                                     <Setter Property="Foreground" Value="#F44336"/>
                                                     <Setter Property="FontWeight" Value="Bold"/>
                                                     <Setter Property="FontSize" Value="14"/>
                                                     <Setter Property="HorizontalAlignment" Value="Center"/>
                                                     <Setter Property="VerticalAlignment" Value="Center"/>
                                                     <Setter Property="Margin" Value="2"/>
                                                 </DataTrigger>
                                                 <DataTrigger Binding="{Binding ConnectionStatus}" Value="Unauthorized">
                                                     <Setter Property="Foreground" Value="#FF9800"/>
                                                     <Setter Property="FontWeight" Value="Bold"/>
                                                     <Setter Property="FontSize" Value="14"/>
                                                     <Setter Property="HorizontalAlignment" Value="Center"/>
                                                     <Setter Property="VerticalAlignment" Value="Center"/>
                                                     <Setter Property="Margin" Value="2"/>
                                                 </DataTrigger>
                                                 <DataTrigger Binding="{Binding ConnectionStatus}" Value="Unknown">
                                                     <Setter Property="Foreground" Value="#9E9E9E"/>
                                                     <Setter Property="FontWeight" Value="Normal"/>
                                                     <Setter Property="FontSize" Value="14"/>
                                                     <Setter Property="HorizontalAlignment" Value="Center"/>
                                                     <Setter Property="VerticalAlignment" Value="Center"/>
                                                     <Setter Property="Margin" Value="2"/>
                                                 </DataTrigger>
                                             </Style.Triggers>
                                         </Style>
                                     </DataGridTextColumn.ElementStyle>
                                 </DataGridTextColumn>
                                 
                                 <!-- Device Name Column -->
                                 <DataGridTextColumn Binding="{Binding DisplayName, Mode=OneWay}" 
                                                     Header="Device Name" 
                                                     Width="*" 
                                                     MinWidth="200" 
                                                     MaxWidth="350" 
                                                     IsReadOnly="True"
                                                     HeaderStyle="{StaticResource CenterAlignedHeaderStyle}"
                                                     CellStyle="{StaticResource LeftAlignedCellStyle}"/>
                                 
                                 <!-- Android Version Column -->
                                 <DataGridTextColumn Binding="{Binding DeviceInfo, Mode=OneWay}" 
                                                     Header="Android Version" 
                                                     Width="*" 
                                                     MinWidth="140" 
                                                     MaxWidth="220" 
                                                     IsReadOnly="True"
                                                     HeaderStyle="{StaticResource CenterAlignedHeaderStyle}"
                                                     CellStyle="{StaticResource CenterAlignedCellStyle}"/>
                                 
                                 <!-- Hardware Summary Column -->
                                 <DataGridTextColumn Binding="{Binding HardwareSummary, Mode=OneWay}" 
                                                     Header="Hardware" 
                                                     Width="*" 
                                                     MinWidth="120" 
                                                     MaxWidth="180" 
                                                     IsReadOnly="True"
                                                     HeaderStyle="{StaticResource CenterAlignedHeaderStyle}"
                                                     CellStyle="{StaticResource CenterAlignedCellStyle}"/>
                                 
                                 <!-- Screen Info Column -->
                                 <!-- <DataGridTextColumn Binding="{Binding ScreenInfo, Mode=OneWay}" 
                                                     Header="Screen" 
                                                     Width="*" 
                                                     MinWidth="100" 
                                                     MaxWidth="150" 
                                                     IsReadOnly="True"
                                                     HeaderStyle="{StaticResource CenterAlignedHeaderStyle}"
                                                     CellStyle="{StaticResource CenterAlignedCellStyle}"/> -->
                                 
                                 <!-- Battery Info Column -->
                                 <DataGridTextColumn Binding="{Binding BatteryInfo, Mode=OneWay}" 
                                                     Header="Battery" 
                                                     Width="*" 
                                                     MinWidth="100" 
                                                     MaxWidth="150" 
                                                     IsReadOnly="True"
                                                     HeaderStyle="{StaticResource CenterAlignedHeaderStyle}"
                                                     CellStyle="{StaticResource CenterAlignedCellStyle}"/>
                                 
                                 <!-- Network Info Column -->
                                 <DataGridTextColumn Binding="{Binding NetworkInfo, Mode=OneWay}" 
                                                     Header="Network" 
                                                     Width="*" 
                                                     MinWidth="100" 
                                                     MaxWidth="150" 
                                                     IsReadOnly="True"
                                                     HeaderStyle="{StaticResource CenterAlignedHeaderStyle}"
                                                     CellStyle="{StaticResource CenterAlignedCellStyle}"/>
                                 
                                 <!-- Root Status Column -->
                                 <DataGridTextColumn Binding="{Binding RootStatus, Mode=OneWay}" 
                                                     Header="Root Status" 
                                                     Width="*" 
                                                     MinWidth="100" 
                                                     MaxWidth="150" 
                                                     IsReadOnly="True"
                                                     HeaderStyle="{StaticResource CenterAlignedHeaderStyle}"
                                                     CellStyle="{StaticResource CenterAlignedCellStyle}"/>
                                 
                                 <!-- Security Status Column -->
                                 <!-- <DataGridTextColumn Binding="{Binding SecurityStatus, Mode=OneWay}" 
                                                     Header="Security" 
                                                     Width="*" 
                                                     MinWidth="100" 
                                                     MaxWidth="150" 
                                                     IsReadOnly="True"
                                                     HeaderStyle="{StaticResource CenterAlignedHeaderStyle}"
                                                     CellStyle="{StaticResource CenterAlignedCellStyle}"/> -->
                                 
                                 <!-- Developer Status Column -->
                                 <!-- <DataGridTextColumn Binding="{Binding DeveloperStatus, Mode=OneWay}" 
                                                     Header="Developer" 
                                                     Width="*" 
                                                     MinWidth="100" 
                                                     MaxWidth="150" 
                                                     IsReadOnly="True"
                                                     HeaderStyle="{StaticResource CenterAlignedHeaderStyle}"
                                                     CellStyle="{StaticResource CenterAlignedCellStyle}"/> -->
                                 
                                 <!-- Connection Health Column -->
                                 <!-- <DataGridTextColumn Binding="{Binding ConnectionHealth, Mode=OneWay}" 
                                                     Header="Health" 
                                                     Width="*" 
                                                     MinWidth="100" 
                                                     MaxWidth="150" 
                                                     IsReadOnly="True"
                                                     HeaderStyle="{StaticResource CenterAlignedHeaderStyle}"
                                                     CellStyle="{StaticResource CenterAlignedCellStyle}"/> -->
                                 
                                                                   <!-- Actions Column -->
                                  <DataGridTemplateColumn Header="Actions" 
                                                         Width="100" 
                                                         HeaderStyle="{StaticResource CenterAlignedHeaderStyle}"
                                                         CellStyle="{StaticResource CenterAlignedCellStyle}">
                                      <DataGridTemplateColumn.CellTemplate>
                                          <DataTemplate>
                                              <Button Content="📊 Details" 
                                                      Style="{StaticResource ModernButtonStyle}"
                                                      Command="{Binding DataContext.ShowSingleDeviceDetailsCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                      CommandParameter="{Binding}"
                                                      FontSize="12" Padding="8,8" Margin="0,0,0,0"
                                                      ToolTip="Show detailed information for this device">
                                                  <Button.Template>
                                                      <ControlTemplate TargetType="Button">
                                                          <Border Background="{TemplateBinding Background}"
                                                                  BorderBrush="{TemplateBinding BorderBrush}"
                                                                  BorderThickness="{TemplateBinding BorderThickness}"
                                                                  Padding="{TemplateBinding Padding}">
                                                              <ContentPresenter HorizontalAlignment="Center" 
                                                                              VerticalAlignment="Center"/>
                                                          </Border>
                                                      </ControlTemplate>
                                                  </Button.Template>
                                              </Button>
                                          </DataTemplate>
                                      </DataGridTemplateColumn.CellTemplate>
                                  </DataGridTemplateColumn>
                                 
                                 <!-- Last Updated Column -->
                                 <!-- <DataGridTextColumn Binding="{Binding LastUpdated, Mode=OneWay}" 
                                                     Header="Updated" 
                                                     Width="*" 
                                                     MinWidth="80" 
                                                     MaxWidth="120" 
                                                     IsReadOnly="True"
                                                     HeaderStyle="{StaticResource CenterAlignedHeaderStyle}"
                                                     CellStyle="{StaticResource CenterAlignedCellStyle}"/> -->
                             </DataGrid.Columns>
                         </DataGrid>
                    </StackPanel>
                </Grid>
                
                <!-- APK Files Module với Groups Support -->
<Grid x:Name="ApkFilesContent" 
      Visibility="{Binding CurrentModule, Converter={StaticResource ModuleToVisibilityConverter}, ConverterParameter='ApkFiles'}">
    <StackPanel>
        <!-- Header Section -->
        <Border CornerRadius="12" Padding="12" Margin="0,0,0,12" 
                Effect="{StaticResource CardShadow}">
            <Border.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                    <GradientStop Color="#764ba2" Offset="0"/>
                    <GradientStop Color="#667eea" Offset="1"/>
                </LinearGradientBrush>
            </Border.Background>
            <StackPanel>
                <TextBlock Text="📦 APK Repository" 
                           FontSize="20" FontWeight="Bold" 
                           Foreground="White" Margin="0,0,0,8"/>
                <TextBlock Text="Search and manage your APK files and groups" 
                           FontSize="12" Foreground="White" Opacity="0.5"/>
            </StackPanel>
        </Border>

        <!-- Repository and View Controls -->
        <Grid Margin="0,0,0,6" Effect="{StaticResource CardShadow}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="180"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            
            <!-- Choose Repository Button -->
            <Button Grid.Column="0" Content="📁 Choose Repository" 
                    Style="{StaticResource ModernButtonStyle}"
                    Command="{Binding ChooseRepoCommand}"
                    Margin="4,0,6,6"
                    FontSize="13" Padding="8,5"/>
            
            <!-- Repository Path TextBox -->
            <TextBox Grid.Column="1" Text="{Binding ApkRepoPath, FallbackValue='No folder selected'}" 
                     Style="{StaticResource ModernTextBoxStyle}"
                     IsReadOnly="True" 
                     VerticalAlignment="Center"
                     Margin="0,0,6,6"
                     FontSize="13" Padding="8,5"/>

            <!-- Create Group Button (only visible in groups view) -->
            <Button Grid.Column="2" Content="➕ New Group" 
                    Style="{StaticResource AccentButtonStyle}"
                    Click="NewGroupButton_Click"
                    FontSize="13" Padding="8,5" Margin="0,0,6,6"
                    Visibility="{Binding ShowGroupsView, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            

            
            <!-- View Toggle Button -->
            <ToggleButton Grid.Column="5" 
                          IsChecked="{Binding ShowGroupsView}"
                          Style="{StaticResource ModernToggleButtonStyle}"
                          FontSize="13" Padding="8,5" Margin="0,0,6,6">
                <ToggleButton.Content>
                    <TextBlock>
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Text" Value="📋 List View"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ShowGroupsView}" Value="True">
                                        <Setter Property="Text" Value="🗂️ Groups View"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </ToggleButton.Content>
            </ToggleButton>

            <!-- Selection Count Badge -->
            <!-- <Border Grid.Column="6" Background="#E8F5E8" CornerRadius="8" Padding="8,5"
                    VerticalAlignment="Center" Margin="0,0,6,6">
                <TextBlock Text="{Binding SelectedApksCountText, FallbackValue='No APK selected'}" 
                           Foreground="#2E7D32" FontSize="13" FontWeight="Medium"/>
            </Border> -->
        </Grid>

        <Border Background="White" CornerRadius="8" Padding="12" Margin="0,0,0,8">
            <StackPanel>
                <!-- Search Panel (always visible) -->
                <Grid Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <TextBlock Grid.Column="0" 
                        Text="🔍 Search:" 
                        VerticalAlignment="Center" 
                        Margin="0,0,8,0"
                        FontSize="14"
                    />
                    <TextBox Grid.Column="1" x:Name="SearchTextBox"
                             Style="{StaticResource ModernTextBoxStyle}"
                             TextChanged="SearchTextBox_TextChanged"
                             Margin="0,0,8,0"
                             ToolTip="Search APKs and groups"/>
                    
                    <TextBlock Grid.Column="2" Text="Ctrl+G: Toggle view | Ctrl+A: Select all | F5: Refresh" 
                               FontSize="14" Foreground="#999" VerticalAlignment="Center"/>
                </Grid>
                
                <!-- Action Buttons and APK Count Panel (below search bar) -->
                <Grid Margin="0,8,0,0" 
                      Visibility="{Binding ShowGroupsView, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Invert}">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Select All Button -->
                    <Button Grid.Column="0" Content="☑️ Select All" 
                            Style="{StaticResource ModernButtonStyle}"
                            Command="{Binding SelectAllApksCommand}"
                            FontSize="13" Padding="8,5" Margin="0,0,8,0"
                            ToolTip="Select all APKs"/>
                    
                    <!-- Clear All Button -->
                    <Button Grid.Column="1" Content="❌ Clear All" 
                            Style="{StaticResource ModernButtonStyle}"
                            Command="{Binding ClearApkSelectionCommand}"
                            FontSize="13" Padding="8,5" Margin="0,0,8,0"
                            ToolTip="Clear all APK selections"/>
                    
                    <!-- Spacer -->
                    <Grid Grid.Column="2"/>
                    
                    <!-- APK Count Status -->
                    <Border Grid.Column="3" Background="#E8F5E8" CornerRadius="8" Padding="8,5"
                            VerticalAlignment="Center" Margin="0,0,6,6">
                        <TextBlock Text="{Binding SelectedApksCountText, FallbackValue='No APK selected'}" 
                                Foreground="#2E7D32" FontSize="13" FontWeight="Medium"/>
                    </Border>
                </Grid>
                
                <!-- Create Group Panel (only visible when ShowGroupsView is true) -->
                <!-- <Grid Visibility="{Binding ShowGroupsView, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <Separator Grid.Row="0" Margin="0,0,0,12"/>
                    
                    <StackPanel Grid.Row="1">
                        <TextBlock Text="Create New Group" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,12"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="200"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <TextBlock Grid.Column="0" Text="Name:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                            <TextBox Grid.Column="1" x:Name="NewGroupNameTextBox"
                                     Text="{Binding NewGroupName, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource ModernTextBoxStyle}"
                                     Margin="0,0,12,0"
                                     ToolTip="Enter group name (Ctrl+N to focus here)"/>
                            
                            <TextBlock Grid.Column="2" Text="Description:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                            <TextBox Grid.Column="3" Text="{Binding NewGroupDescription, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource ModernTextBoxStyle}"
                                     Margin="0,0,12,0"
                                     ToolTip="Optional description"/>
                            
                            <Button Grid.Column="4" Content="Create Group"
                                    Style="{StaticResource AccentButtonStyle}"
                                    Command="{Binding CreateGroupCommand}"
                                    IsEnabled="{Binding NewGroupName, Converter={StaticResource StringToBooleanConverter}}"/>
                        </Grid>
                    </StackPanel>
                </Grid> -->
            </StackPanel>
        </Border>

        <!-- Content: List View or Groups View -->
        <Grid>
            <!-- List View (Original DataGrid) -->
            <DataGrid x:Name="ApkFilesDataGrid"
                      ItemsSource="{Binding ApkFiles}" 
                      AutoGenerateColumns="False" 
                      CanUserAddRows="False"
                      CanUserDeleteRows="False"
                      CanUserResizeRows="False"
                      GridLinesVisibility="None"
                      HeadersVisibility="Column"
                      SelectionMode="Single"
                      Background="White"
                      RowBackground="White"
                      AlternatingRowBackground="#F8F9FA"
                      RowHeight="36"
                      FontSize="12"
                      FontFamily="{StaticResource SrotoneRegular}"
                      BorderThickness="0"
                      BorderBrush="#E0E0E0"
                      CanUserSortColumns="True"
                      CanUserReorderColumns="False"
                      IsReadOnly="False"
                      EnableRowVirtualization="True"
                      EnableColumnVirtualization="True"
                      VirtualizingStackPanel.IsVirtualizing="True"
                      ScrollViewer.CanContentScroll="True"
                      ScrollViewer.VerticalScrollBarVisibility="Auto"
                      ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                      ScrollViewer.PanningMode="VerticalOnly"
                      MaxHeight="400"
                      IsSynchronizedWithCurrentItem="False"
                      IsTextSearchEnabled="False"
                      ColumnHeaderHeight="36"
                      SelectionChanged="ApkFilesDataGrid_SelectionChanged"
                      Visibility="{Binding ShowGroupsView, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Invert}">
                <DataGrid.Resources>
                    <!-- Existing styles from original code -->
                    <Style x:Key="CenterAlignedCellStyle" TargetType="DataGridCell">
                        <Setter Property="BorderBrush" Value="#F5F5F5"/>
                        <Setter Property="BorderThickness" Value="0,0,0,1"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="DataGridCell">
                                    <Border BorderBrush="{TemplateBinding BorderBrush}" 
                                            BorderThickness="{TemplateBinding BorderThickness}"
                                            Background="{TemplateBinding Background}">
                                        <ContentPresenter HorizontalAlignment="Center" 
                                                        VerticalAlignment="Center" 
                                                        Margin="3"/>
                                    </Border>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                    <Style x:Key="LeftAlignedCellStyle" TargetType="DataGridCell">
                        <Setter Property="FontFamily" Value="{StaticResource SrotoneRegular}"/>
                        <Setter Property="BorderBrush" Value="#F5F5F5"/>
                        <Setter Property="BorderThickness" Value="0,0,0,1"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="DataGridCell">
                                    <Border BorderBrush="{TemplateBinding BorderBrush}" 
                                            BorderThickness="{TemplateBinding BorderThickness}" 
                                            Background="{TemplateBinding Background}">
                                        <ContentPresenter HorizontalAlignment="Left" 
                                                        VerticalAlignment="Center" 
                                                        Margin="2"/>
                                    </Border>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                    <Style x:Key="CenterAlignedHeaderStyle" TargetType="DataGridColumnHeader">
                        <Setter Property="HorizontalContentAlignment" Value="Center"/>
                        <Setter Property="VerticalContentAlignment" Value="Center"/>
                        <Setter Property="FontWeight" Value="SemiBold"/>
                        <Setter Property="FontSize" Value="13"/>
                        <Setter Property="Foreground" Value="#333"/>
                    </Style>
                    <Style x:Key="CenterAlignedCheckBoxColumnStyle" TargetType="DataGridCell">
                        <Setter Property="BorderBrush" Value="#F5F5F5"/>
                        <Setter Property="BorderThickness" Value="0,0,0,1"/>
                        <Setter Property="FontWeight" Value="Medium"/>
                        <Setter Property="FontSize" Value="16"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="DataGridCell">
                                    <Border BorderBrush="{TemplateBinding BorderBrush}" 
                                            BorderThickness="{TemplateBinding BorderThickness}" 
                                            Background="{TemplateBinding Background}">
                                        <ContentPresenter HorizontalAlignment="Center" 
                                                        VerticalAlignment="Center" 
                                                        Margin="2"/>
                                    </Border>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </DataGrid.Resources>
                <DataGrid.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="Add to Group" 
                                  ItemsSource="{Binding ApkGroups}">
                            <MenuItem.ItemContainerStyle>
                                <Style TargetType="MenuItem">
                                    <Setter Property="Header" Value="{Binding Name}"/>
                                    <Setter Property="Command" Value="{Binding DataContext.AddSelectedApksToGroupCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                    <Setter Property="CommandParameter" Value="{Binding}"/>
                                </Style>
                            </MenuItem.ItemContainerStyle>
                        </MenuItem>
                    </ContextMenu>
                </DataGrid.ContextMenu>
                <DataGrid.Columns>
                    <DataGridCheckBoxColumn Binding="{Binding IsSelected, UpdateSourceTrigger=PropertyChanged}" 
                                            Header="✓" 
                                            Width="50"
                                            HeaderStyle="{StaticResource CenterAlignedHeaderStyle}"
                                            CellStyle="{StaticResource CenterAlignedCheckBoxColumnStyle}"/>
                    <DataGridTextColumn Binding="{Binding DisplayInfo, Mode=OneWay}" 
                                        Header="APK Information" 
                                        Width="*" 
                                        MinWidth="150" 
                                        MaxWidth="250" 
                                        IsReadOnly="True"
                                        HeaderStyle="{StaticResource CenterAlignedHeaderStyle}"
                                        CellStyle="{StaticResource LeftAlignedCellStyle}"/>
                    <DataGridTextColumn Binding="{Binding FileSize, Mode=OneWay}" 
                                        Header="Size" 
                                        Width="*" 
                                        MinWidth="80" 
                                        MaxWidth="120" 
                                        IsReadOnly="True"
                                        HeaderStyle="{StaticResource CenterAlignedHeaderStyle}"
                                        CellStyle="{StaticResource CenterAlignedCellStyle}"/>
                    <DataGridTextColumn Binding="{Binding LastModified, Mode=OneWay}" 
                                        Header="Modified" 
                                        Width="*" 
                                        MinWidth="120" 
                                        MaxWidth="180" 
                                        IsReadOnly="True"
                                        HeaderStyle="{StaticResource CenterAlignedHeaderStyle}"
                                        CellStyle="{StaticResource CenterAlignedCellStyle}"/>
                    <DataGridTextColumn Binding="{Binding SplitTag, Mode=OneWay}" 
                                        Header="Split" 
                                        Width="*" 
                                        MinWidth="80" 
                                        MaxWidth="120" 
                                        IsReadOnly="True"
                                        HeaderStyle="{StaticResource CenterAlignedHeaderStyle}"
                                        CellStyle="{StaticResource CenterAlignedCellStyle}"/>
                    <DataGridTemplateColumn Header="Actions" Width="120">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <Button Content="📋" 
                                            ToolTip="Copy to Device"
                                            Command="{Binding DataContext.CopyToDeviceCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                            CommandParameter="{Binding}"
                                            Style="{StaticResource IconButtonStyle}"
                                            Margin="0,0,5,0"/>
                                    <Button Content="📤" 
                                            ToolTip="Install APK"
                                            Command="{Binding DataContext.InstallApkCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                            CommandParameter="{Binding}"
                                            Style="{StaticResource IconButtonStyle}"/>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                                        
                </DataGrid.Columns>
            </DataGrid>

            <!-- Groups View (TreeView) -->
        <ScrollViewer VerticalScrollBarVisibility="Auto" 
                    MaxHeight="600"
                    Visibility="{Binding ShowGroupsView, Converter={StaticResource BooleanToVisibilityConverter}}">

                <StackPanel>
                    <!-- Groups List -->
                    <ItemsControl ItemsSource="{Binding ApkGroups}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="White" 
                                        CornerRadius="8" 
                                        Margin="4,4,4,4" 
                                        Padding="12"
                                        Effect="{StaticResource CardShadow}"
                                        AllowDrop="True"
                                        Drop="GroupCard_Drop"
                                        DragEnter="GroupCard_DragEnter"
                                        DragLeave="GroupCard_DragLeave"
                                        PreviewMouseLeftButtonDown="GroupCard_MouseDoubleClick">
                                    <StackPanel>
                                        <!-- Group Header -->
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <!-- Group Selection Checkbox -->
                                            <CheckBox Grid.Column="0" 
                                                      IsChecked="{Binding IsGroupSelected, Mode=TwoWay}"
                                                      Command="{Binding SelectAllApksCommand}"
                                                      Margin="0,0,8,0"
                                                      VerticalAlignment="Center"
                                                      ToolTip="Select/Deselect all APKs in this group"/>
                                            
                                            <!-- Expand/Collapse Button -->
                                            <Button Grid.Column="1" 
                                                    Style="{StaticResource ModernButtonStyle}"
                                                    Width="30" Height="30"
                                                    FontSize="12"
                                                    Margin="0,0,12,0"
                                                    Click="GroupExpander_Click">
                                                <Button.Content>
                                                    <TextBlock>
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Text" Value="🔽"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsExpanded}" Value="False">
                                                                        <Setter Property="Text" Value="🔼"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </Button.Content>
                                            </Button>
                                            
                                            <!-- Group Info -->
                                            <StackPanel Grid.Column="2" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding DisplayName}" 
                                                           FontSize="16" FontWeight="SemiBold"
                                                           Foreground="#333"/>
                                                <TextBlock Text="{Binding GroupInfo}" 
                                                           FontSize="12" 
                                                           Foreground="#666"/>
                                                <TextBlock Text="{Binding Description}" 
                                                           FontSize="12" 
                                                           Foreground="#888"
                                                           Visibility="{Binding Description, Converter={StaticResource StringToVisibilityConverter}}"/>
                                                <!-- <TextBlock Text="{Binding CreatedAtText}" 
                                                           FontSize="10" 
                                                           Foreground="#AAA"/> -->
                                            </StackPanel>
                                            
                                            <!-- Group Actions -->
                                            <Button Grid.Column="3" Content="➕ Add APKs"
                                                    Style="{StaticResource AccentButtonStyle}"
                                                    Command="{Binding DataContext.AddSelectedApksToGroupCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                    CommandParameter="{Binding}"
                                                    FontSize="12" Padding="8,1"
                                                    Margin="0,0,6,0"
                                                    ToolTip="Add selected APKs to this group"/>

                                            <!-- <Button Grid.Column="3" Content="☑️ Select All"
                                                    Style="{StaticResource ModernButtonStyle}"
                                                    Command="{Binding SelectAllApksCommand}"
                                                    FontSize="12" Padding="8,1"
                                                    Margin="0,0,6,0"
                                                    ToolTip="Select all APKs in this group"/>
                                            

                                            <Button Grid.Column="4" Content="🗑️ Delete Selected"
                                                    Style="{StaticResource ModernButtonStyle}"
                                                    Command="{Binding DataContext.DeleteSelectedApksFromGroupCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    CommandParameter="{Binding}"
                                                    FontSize="12" Padding="8,1"
                                                    Background="#FF9800"
                                                    Margin="0,0,6,0"
                                                    ToolTip="Delete selected APKs from this group"/> -->
                                            
                                            <Button Grid.Column="4" Content="🗑️ Delete Group"
                                                    Style="{StaticResource ModernButtonStyle}"
                                                    Command="{Binding DataContext.DeleteGroupCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                    CommandParameter="{Binding}"
                                                    FontSize="12" Padding="8,1"
                                                    Background="#F44336"
                                                    ToolTip="Delete this group (APK files will not be deleted)"/>
                                        </Grid>
                                        
                                        <!-- APKs in Group -->
                                        <Border Margin="0,12,0,0" 
                                                Visibility="{Binding IsExpanded, Converter={StaticResource BooleanToVisibilityConverter}}">
                                            <ItemsControl ItemsSource="{Binding ApkItems}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border Background="#F8F9FA" 
                                                                CornerRadius="4" 
                                                                Padding="12,8" 
                                                                Margin="0,0,0,4"
                                                                PreviewMouseLeftButtonDown="ApkItem_PreviewMouseLeftButtonDown"
                                                                MouseMove="ApkItem_MouseMove"
                                                                MouseRightButtonUp="ShowApkContextMenu">
                                                            <Grid>
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                    <ColumnDefinition Width="*"/>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                </Grid.ColumnDefinitions>
                                                                
                                                                <CheckBox Grid.Column="0" 
                                                                          IsChecked="{Binding IsSelected}"
                                                                          Margin="0,0,12,0"/>
                                                                
                                                                <TextBlock Grid.Column="1" 
                                                                           Text="{Binding DisplayInfo}" 
                                                                           FontWeight="Medium"
                                                                           VerticalAlignment="Center"
                                                                           ToolTip="{Binding FilePath}"/>
                                                                
                                                                <TextBlock Grid.Column="2" 
                                                                           Text="{Binding FileSize}" 
                                                                           FontSize="12" 
                                                                           Foreground="#666"
                                                                           VerticalAlignment="Center"
                                                                           Margin="0,0,12,0"/>
                                                                
                                                                <TextBlock Grid.Column="3" 
                                                                           Text="{Binding LastModified}" 
                                                                           FontSize="12" 
                                                                           Foreground="#666"
                                                                           VerticalAlignment="Center"
                                                                           Margin="0,0,12,0"/>
                                                                
                                                                <TextBlock Grid.Column="4" 
                                                                           Text="{Binding SplitTag}" 
                                                                           FontSize="12" 
                                                                           Foreground="#666"
                                                                           VerticalAlignment="Center"
                                                                           Margin="0,0,12,0"/>
                                                                
                                                                <Button Grid.Column="5" Content="🗑️"
                                                                         Style="{StaticResource ModernButtonStyle}"
                                                                         Background="#F44336"
                                                                         Width="24" Height="24"
                                                                         FontSize="10"
                                                                         Click="RemoveApkFromGroup_Click"
                                                                         ToolTip="Remove APK from group"
                                                                         Margin="0,0,0,0"
                                                                         Tag="{Binding}"/>
                                                            </Grid>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </Border>
                                        
                                        <!-- Empty Group Message -->
                                        <Border Background="White" 
                                                CornerRadius="8" 
                                                Padding="32"
                                                Visibility="{Binding ApkItems.Count, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Invert}">
                                            <StackPanel HorizontalAlignment="Center">
                                                <TextBlock Text="📁" FontSize="48" HorizontalAlignment="Center" Margin="0,0,0,16"/>
                                                <TextBlock Text="No APKs in this group yet" 
                                                        FontSize="16" FontWeight="SemiBold"
                                                        HorizontalAlignment="Center" 
                                                        Foreground="#666"
                                                        Margin="0,0,0,8"/>
                                                <TextBlock Text="Use 'Add APKs' button or drag &amp; drop APKs here"
                                                        FontSize="14" 
                                                        HorizontalAlignment="Center" 
                                                        Foreground="#888"/>
                                            </StackPanel>
                                        </Border>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    
                    <!-- Empty Groups Message -->
                    <Border Background="White" 
                            CornerRadius="8" 
                            Padding="32"
                            Visibility="{Binding ApkGroups.Count, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Invert}">
                        <StackPanel HorizontalAlignment="Center">
                            <TextBlock Text="📁" FontSize="48" HorizontalAlignment="Center" Margin="0,0,0,16"/>
                            <TextBlock Text="No groups created yet" 
                                    FontSize="16" FontWeight="SemiBold"
                                    HorizontalAlignment="Center" 
                                    Foreground="#666"
                                    Margin="0,0,0,8"/>
                            <TextBlock Text="Create your first group to organize your APK files"
                                    FontSize="14" 
                                    HorizontalAlignment="Center" 
                                    Foreground="#888"/>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </ScrollViewer>
        </Grid>
                    </StackPanel>
                </Grid>
                
                <!-- Install Queue Module -->
                <Grid x:Name="InstallQueueContent" 
                      Visibility="{Binding CurrentModule, Converter={StaticResource ModuleToVisibilityConverter}, ConverterParameter='InstallQueue'}">
                    <StackPanel>
                        <!-- Header Section -->
                         <Border CornerRadius="12" Padding="12" Margin="0,0,0,12" 
                                 Effect="{StaticResource CardShadow}">
                             <Border.Background>
                                 <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                     <GradientStop Color="#764ba2" Offset="0"/>
                                     <GradientStop Color="#667eea" Offset="1"/>
                                 </LinearGradientBrush>
                             </Border.Background>
                             <StackPanel>
                                 <TextBlock Text="⏳ Installation Queue" 
                                            FontSize="20" FontWeight="Bold" 
                                            Foreground="White" Margin="0,0,0,8"/>
                                 <TextBlock Text="Select devices and APKs, then click Install" 
                                            FontSize="12" Foreground="White" Opacity="0.5"/>
                             </StackPanel>
                         </Border>
                        
                        <!-- Installation Controls -->
                        <Grid Margin="0,0,0,16">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Button Grid.Column="0" Content="⚡ Install on Selected Devices" 
                                    Style="{StaticResource AccentButtonStyle}"
                                    Command="{Binding InstallOnSelectedCommand}"
                                    FontSize="14" Padding="20,10" Margin="0,0,12,0" VerticalAlignment="Center"/>
                            <!-- <TextBlock Grid.Column="1" Text="Select devices and APKs, then click Install" 
                                       Foreground="#666" VerticalAlignment="Center"/> -->
                            <CheckBox Grid.Column="1" Content="Reinstall (-r)" 
                                      IsChecked="{Binding OptReinstall}" 
                                      FontSize="12" Margin="0,0,12,0" VerticalAlignment="Center"/>
                            <CheckBox Grid.Column="2" Content="Grant Permissions (-g)" 
                                      IsChecked="{Binding OptGrantPerms}" 
                                      FontSize="12" Margin="0,0,12,0" VerticalAlignment="Center"/>
                            <CheckBox Grid.Column="3" Content="Allow Downgrade (-d)" 
                                      IsChecked="{Binding OptDowngrade}"
                                      FontSize="12" Margin="0,0,12,0" VerticalAlignment="Center"/>
                        </Grid>
                        
                        <!-- Queue Status -->
                        <Border Background="White" CornerRadius="8" Padding="16" Margin="0,0,0,16">
                            <StackPanel>
                                <TextBlock Text="Queue Status" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,12"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                                        <TextBlock Text="{Binding Devices.Count, FallbackValue=0}" FontSize="24" FontWeight="Bold" Foreground="#2196F3"/>
                                        <TextBlock Text="Total Devices" Foreground="#666"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                                        <TextBlock Text="{Binding ApkFiles.Count, FallbackValue=0}" FontSize="24" FontWeight="Bold" Foreground="#4CAF50"/>
                                        <TextBlock Text="Total APKs" Foreground="#666"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                                        <TextBlock Text="{Binding BaseApkCount, FallbackValue=0}" FontSize="24" FontWeight="Bold" Foreground="#FF9800"/>
                                        <TextBlock Text="Base APKs" Foreground="#666"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="3" HorizontalAlignment="Center">
                                        <TextBlock Text="{Binding SplitApkCount, FallbackValue=0}" FontSize="24" FontWeight="Bold" Foreground="#9C27B0"/>
                                        <TextBlock Text="Split APKs" Foreground="#666"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="4" HorizontalAlignment="Center">
                                        <TextBlock Text="{Binding SelectedApksCount, FallbackValue=0}" FontSize="24" FontWeight="Bold" Foreground="#2E7D32"/>
                                        <TextBlock Text="Selected APKs" Foreground="#666"/>
                                    </StackPanel>
                                </Grid>
                            </StackPanel>
                        </Border>
                        
                        <!-- Installation Log -->
                        <Border Background="White" CornerRadius="8" Padding="16">
                            <StackPanel>
                                <Grid Margin="0,0,0,12">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="📄 Installation Log" FontSize="16" FontWeight="SemiBold"/>
                                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                                        <CheckBox x:Name="AutoScrollCheckBox" 
                                                  Content="Auto-scroll" 
                                                  IsChecked="True" 
                                                  Margin="0,0,8,0" 
                                                  VerticalAlignment="Center"/>
                                        <Button Content="📍 Go to Bottom" 
                                                Style="{StaticResource ModernButtonStyle}"
                                                Click="GoToBottom_Click"
                                                FontSize="12" 
                                                Padding="8,4"/>
                                    </StackPanel>
                                </Grid>
                                <Border Background="#1E1E1E" CornerRadius="4" Padding="12" Width="Auto">
                                    <ScrollViewer x:Name="LogScrollViewer" 
                                                  VerticalScrollBarVisibility="Auto" 
                                                  MaxHeight="200"
                                                  ScrollChanged="LogScrollViewer_ScrollChanged">
                                        <TextBlock x:Name="LogTextBlock"
                                                   Text="{Binding LogText, FallbackValue='No log entries yet'}" 
                                                   Background="Transparent"
                                                   Foreground="#FFFFFF"
                                                   FontFamily="Consolas" 
                                                   FontSize="12"
                                                   TextWrapping="Wrap"/>
                                    </ScrollViewer>
                                </Border>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </Grid>
                
                <!-- Settings Module -->
                <Grid x:Name="SettingsContent" 
                      Visibility="{Binding CurrentModule, Converter={StaticResource ModuleToVisibilityConverter}, ConverterParameter='Settings'}">
                    <StackPanel>
                        <TextBlock Text="⚙️ Settings" 
                                   FontSize="24" FontWeight="Bold" 
                                   Foreground="#333" Margin="0,0,0,20"/>
                        
                        <Border Background="White" CornerRadius="8" Padding="20">
                            <StackPanel>
                                <TextBlock Text="Application Settings" FontSize="18" FontWeight="SemiBold" Margin="0,0,0,20"/>
                                
                                <Grid Margin="0,0,0,16">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="200" MinWidth="150" MaxWidth="300"/>
                                        <ColumnDefinition Width="*" MinWidth="200"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    
                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="APK Repository:" VerticalAlignment="Center"/>
                                    <Grid Grid.Row="0" Grid.Column="1">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" MinWidth="200"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBox Grid.Column="0" Text="{Binding ApkRepoPath, FallbackValue='No folder selected'}" 
                                                 Style="{StaticResource ModernTextBoxStyle}"
                                                 Margin="0,0,8,0"/>
                                        <Button Grid.Column="1" Content="Browse" 
                                                Style="{StaticResource ModernButtonStyle}"
                                                Command="{Binding ChooseRepoCommand}"/>
                                    </Grid>
                                    
                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Installation Options:" VerticalAlignment="Center" Margin="0,16,0,0"/>
                                    <Grid Grid.Row="1" Grid.Column="1" Margin="0,16,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <CheckBox Grid.Column="0" Content="Reinstall (-r)" 
                                                  IsChecked="{Binding OptReinstall}" 
                                                  Margin="0,0,16,0" VerticalAlignment="Center"/>
                                        <CheckBox Grid.Column="1" Content="Grant Permissions (-g)" 
                                                  IsChecked="{Binding OptGrantPerms}" 
                                                  Margin="0,0,16,0" VerticalAlignment="Center"/>
                                        <CheckBox Grid.Column="2" Content="Allow Downgrade (-d)" 
                                                  IsChecked="{Binding OptDowngrade}"
                                                  Margin="0,0,16,0" VerticalAlignment="Center"/>
                                    </Grid>
                                    
                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Actions:" VerticalAlignment="Center" Margin="0,16,0,0"/>
                                    <StackPanel Grid.Row="2" Grid.Column="1" Orientation="Horizontal" Margin="0,16,0,0">
                                        <Button Content="Save Settings" 
                                                Style="{StaticResource AccentButtonStyle}"
                                                Command="{Binding SaveSettingsCommand}"
                                                Margin="0,0,12,0"/>
                                        <Button Content="Reset to Defaults" 
                                                Style="{StaticResource ModernButtonStyle}"
                                                Command="{Binding ResetToDefaultsCommand}"/>
                                    </StackPanel>
                                </Grid>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </Grid>
                
                <!-- Installed Apps Module -->
                <Grid x:Name="InstalledAppsContent" 
                      Visibility="{Binding CurrentModule, Converter={StaticResource ModuleToVisibilityConverter}, ConverterParameter='InstalledApps'}">
                    <StackPanel>
                        <TextBlock Text="📋 Installed Apps" 
                                   FontSize="24" FontWeight="Bold" 
                                   Foreground="#333" Margin="0,0,0,20"/>
                        
                        <Border Background="White" CornerRadius="8" Padding="20">
                            <StackPanel>
                                <TextBlock Text="App Management" FontSize="18" FontWeight="SemiBold" Margin="0,0,0,20"/>
                                
                                <Grid Margin="0,0,0,16">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="200" MinWidth="150" MaxWidth="300"/>
                                        <ColumnDefinition Width="*" MinWidth="200"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    
                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Select Device:" VerticalAlignment="Center"/>
                                    <ComboBox Grid.Row="0" Grid.Column="1" 
                                              ItemsSource="{Binding Devices}"
                                              SelectedItem="{Binding SelectedDevice}"
                                              DisplayMemberPath="DisplayName"
                                              MinWidth="200">
                                    </ComboBox>
                                    
                                    <!-- Device Status Display -->
                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Status:" VerticalAlignment="Center" Margin="0,8,0,0"/>
                                    <TextBlock Grid.Row="1" Grid.Column="1" 
                                               Text="{Binding DeviceStatusSummary}" 
                                               VerticalAlignment="Center"
                                               Foreground="#666" 
                                               FontSize="12"
                                               Margin="0,8,0,0"/>
                                    
                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Export Directory:" VerticalAlignment="Center" Margin="0,16,0,0"/>
                                    <Grid Grid.Row="2" Grid.Column="1" Margin="0,16,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" MinWidth="200"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBox Grid.Column="0" Text="{Binding ExportDirectory, FallbackValue='No folder selected'}" 
                                                 Style="{StaticResource ModernTextBoxStyle}"
                                                 Margin="0,0,8,0"/>
                                        <Button Grid.Column="1" Content="Browse" 
                                                Style="{StaticResource ModernButtonStyle}"
                                                Command="{Binding ChooseExportDirectoryCommand}"/>
                                    </Grid>
                                    
                                    <TextBlock Grid.Row="3" Grid.Column="0" Text="Actions:" VerticalAlignment="Center" Margin="0,16,0,0"/>
                                    <StackPanel Grid.Row="3" Grid.Column="1" Orientation="Horizontal" Margin="0,16,0,0">
                                        <Button Content="🔄 Refresh Apps" 
                                                Style="{StaticResource AccentButtonStyle}"
                                                Command="{Binding RefreshInstalledAppsCommand}"
                                                Margin="0,0,12,0"/>
                                        <Button Content="📦 Export Selected" 
                                                Style="{StaticResource ModernButtonStyle}"
                                                Command="{Binding ExportSelectedApksCommand}"
                                                Margin="0,0,12,0"/>
                                        <TextBlock Text="{Binding SelectedInstalledAppsCountText}" 
                                                   VerticalAlignment="Center"
                                                   Foreground="#666" 
                                                   FontSize="12"/>
                                    </StackPanel>
                                </Grid>
                            </StackPanel>
                        </Border>
                        
                        <!-- Apps List -->
                        <Border Background="White" CornerRadius="8" Padding="20" Margin="0,16,0,0">
                            <StackPanel>
                                <Grid Margin="0,0,0,16">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="📱 Installed Applications" FontSize="18" FontWeight="SemiBold"/>
                                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                                        <Button Content="Select All" 
                                                Style="{StaticResource ModernButtonStyle}"
                                                Command="{Binding SelectAllInstalledAppsCommand}"
                                                Margin="0,0,8,0" FontSize="12" Padding="8,4"/>
                                        <Button Content="Clear Selection" 
                                                Style="{StaticResource ModernButtonStyle}"
                                                Command="{Binding ClearInstalledAppsSelectionCommand}"
                                                FontSize="12" Padding="8,4"/>
                                    </StackPanel>
                                </Grid>
                                
                                <!-- Filter Controls -->
                                <Grid Margin="0,0,0,16">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <TextBox Grid.Column="0" Text="{Binding AppFilterKeyword, UpdateSourceTrigger=PropertyChanged}" 
                                             Style="{StaticResource ModernTextBoxStyle}"
                                             FontSize="14" Height="35"
                                             VerticalContentAlignment="Center"
                                             Margin="0,0,12,0">
                                        <TextBox.Template>
                                            <ControlTemplate TargetType="TextBox">
                                                <Border Background="{TemplateBinding Background}" 
                                                        BorderBrush="{TemplateBinding BorderBrush}" 
                                                        BorderThickness="{TemplateBinding BorderThickness}"
                                                        CornerRadius="4">
                                                    <Grid>
                                                        <ScrollViewer x:Name="PART_ContentHost" 
                                                                    Margin="10,0,30,0"
                                                                    VerticalAlignment="Center"/>
                                                        <TextBlock Text="🔍 Search apps..." 
                                                                 Foreground="{StaticResource TextSecondaryBrush}"
                                                                 Margin="10,0,0,0"
                                                                 VerticalAlignment="Center"
                                                                 IsHitTestVisible="False"
                                                                 Visibility="{Binding Text, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource StringToVisibilityConverter}, ConverterParameter=Invert}"/>
                                                    </Grid>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsFocused" Value="True">
                                                        <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrush}"/>
                                                        <Setter Property="BorderThickness" Value="2"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </TextBox.Template>
                                    </TextBox>
                                    
                                    <CheckBox Grid.Column="1" Content="User Apps Only" 
                                              IsChecked="{Binding ShowUserAppsOnly}" 
                                              FontSize="14" VerticalAlignment="Center"
                                              Margin="0,0,12,0"/>
                                    <CheckBox Grid.Column="2" Content="Include System Apps" 
                                              IsChecked="{Binding ShowSystemApps}" 
                                              FontSize="14" VerticalAlignment="Center"/>
                                </Grid>
                                
                                <!-- Loading Indicator -->
                                <Border Background="#F0F0F0" CornerRadius="4" Padding="20" 
                                        Visibility="{Binding IsLoadingApps, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <StackPanel HorizontalAlignment="Center">
                                        <ProgressBar IsIndeterminate="True" Width="200" Height="4" 
                                                   Foreground="{StaticResource PrimaryBrush}" Margin="0,0,0,10"/>
                                        <TextBlock Text="Loading installed apps..." 
                                                 FontSize="14" FontWeight="Medium"
                                                 Foreground="{StaticResource TextPrimaryBrush}"
                                                 HorizontalAlignment="Center"/>
                                    </StackPanel>
                                </Border>
                                
                                <!-- Apps DataGrid -->
                                <DataGrid ItemsSource="{Binding InstalledApps}" 
                                          AutoGenerateColumns="False"
                                          CanUserAddRows="False" CanUserDeleteRows="False"
                                          CanUserResizeRows="False" CanUserSortColumns="True"
                                          GridLinesVisibility="None"
                                          HeadersVisibility="Column"
                                          SelectionMode="Extended"
                                          RowStyle="{StaticResource ModernDataGridRowStyle}"
                                          ColumnHeaderStyle="{StaticResource ModernDataGridHeaderStyle}"
                                          CellStyle="{StaticResource ModernDataGridCellStyle}"
                                          Background="Transparent"
                                          BorderThickness="0"
                                          MaxHeight="400">
                                    
                                    <DataGrid.Columns>
                                        <!-- Selection Column -->
                                        <DataGridTemplateColumn Header="Select" Width="60" CanUserSort="False">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <CheckBox IsChecked="{Binding IsSelected, UpdateSourceTrigger=PropertyChanged}" 
                                                            HorizontalAlignment="Center" VerticalAlignment="Center"
                                                            Style="{StaticResource ModernDataGridCheckBoxStyle}"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>

                                        <!-- App Name Column -->
                                        <DataGridTextColumn Header="App Name" Binding="{Binding DisplayName}" 
                                                          Width="*" MinWidth="200"/>

                                        <!-- Package Name Column -->
                                        <DataGridTextColumn Header="Package Name" Binding="{Binding PackageName}" 
                                                          Width="250"/>

                                        <!-- Version Column -->
                                        <DataGridTextColumn Header="Version" Binding="{Binding VersionInfo}" 
                                                          Width="120"/>

                                        <!-- Type Column -->
                                        <DataGridTextColumn Header="Type" Binding="{Binding AppType}" 
                                                          Width="80"/>

                                        <!-- Size Column -->
                                        <DataGridTextColumn Header="Size" Binding="{Binding SizeInfo}" 
                                                          Width="100"/>

                                        <!-- Splits Column -->
                                        <DataGridTextColumn Header="Splits" Binding="{Binding SplitInfo}" 
                                                          Width="80"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </Grid>
                
                <!-- Multi-Group Install Module -->
                <Grid x:Name="MultiGroupInstallContent" 
                      Visibility="{Binding CurrentModule, Converter={StaticResource ModuleToVisibilityConverter}, ConverterParameter='MultiGroupInstall'}">
                    <Grid Background="{DynamicResource MaterialDesignPaper}">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <!-- Header -->
                        <Grid Grid.Row="0" Margin="16,8,16,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="Multi-Group APK Installation" FontSize="20" FontWeight="SemiBold"/>
                                <TextBlock Text="{Binding MultiGroupInstall.HeaderInfo}" Foreground="#7A7A7A" Margin="8,3,0,0"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                <Button Content="▶️ Start Installation" Command="{Binding MultiGroupInstall.StartInstallCommand}" 
                                        Style="{StaticResource AccentButtonStyle}" Margin="0,0,8,0" MinWidth="140" />
                                <Button Content="⏹️ Cancel" Command="{Binding MultiGroupInstall.CancelInstallCommand}" 
                                        Margin="0,0,8,0" MinWidth="80" />
                                <Button Content="🔄 Refresh" Command="{Binding MultiGroupInstall.RefreshGroupsCommand}" 
                                        Style="{StaticResource ModernButtonStyle}" MinWidth="90" />
                            </StackPanel>
                        </Grid>

                        <!-- Content: 3 columns with splitters -->
                        <Grid Grid.Row="1" Margin="16">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="2.2*" MinWidth="360"/>
                                <ColumnDefinition Width="8"/>
                                <ColumnDefinition Width="2.6*" MinWidth="420"/>
                                <ColumnDefinition Width="8"/>
                                <ColumnDefinition Width="2.2*" MinWidth="360"/>
                            </Grid.ColumnDefinitions>

                            <!-- Devices Panel -->
                            <Border Grid.Column="0" Padding="12" CornerRadius="10" Background="White"
                                    BorderBrush="#E6E6E6" BorderThickness="1">
                                <DockPanel>
                                    <StackPanel DockPanel.Dock="Top" Margin="0,0,0,16">
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                                            <TextBlock Text="Devices" FontWeight="SemiBold" FontSize="16" VerticalAlignment="Center"/>
                                            <TextBlock Text="{Binding MultiGroupInstall.DevicesSummary}" Foreground="#7A7A7A" Margin="12,0,0,0" VerticalAlignment="Center"/>
                                            <Button Content="🔄" Command="{Binding MultiGroupInstall.RefreshDevicesCommand}" 
                                                    ToolTip="Refresh Devices" Width="32" Height="32" Margin="12,0,0,0"/>
                                        </StackPanel>
                                        <Grid Margin="0,0,0,12">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBox Grid.Column="0" Text="{Binding MultiGroupInstall.DeviceFilter, UpdateSourceTrigger=PropertyChanged}"
                                                     Margin="0,0,8,0" ToolTip="Filter devices..."/>
                                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                                <Button Content="All" Command="{Binding MultiGroupInstall.SelectAllDevicesCommand}" 
                                                        Margin="0,0,4,0" MinWidth="50"/>
                                                <Button Content="Online" Command="{Binding MultiGroupInstall.SelectOnlineDevicesCommand}" 
                                                        Margin="0,0,4,0" MinWidth="60"/>
                                                <Button Content="None" Command="{Binding MultiGroupInstall.SelectNoneDevicesCommand}" 
                                                        MinWidth="50"/>
                                            </StackPanel>
                                        </Grid>
                                    </StackPanel>

                                    <ListView ItemsSource="{Binding MultiGroupInstall.DevicesView}" SelectionMode="Extended"
                                              ScrollViewer.CanContentScroll="True"
                                              VirtualizingPanel.IsVirtualizing="True"
                                              VirtualizingPanel.VirtualizationMode="Recycling"
                                              Background="#FAFAFA" BorderThickness="1" BorderBrush="#E0E0E0">
                                        <ListView.ItemTemplate>
                                            <DataTemplate DataType="{x:Type vm:DeviceViewModel}">
                                                <Border Background="White" CornerRadius="8" Margin="4,2" Padding="8" 
                                                        BorderThickness="1" BorderBrush="#E0E0E0">
                                                    <Grid ToolTip="{Binding ConnectionDiagnosis}">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="32"/>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                        </Grid.ColumnDefinitions>
                                                        <CheckBox IsChecked="{Binding IsSelected, Mode=TwoWay}" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                                        <StackPanel Grid.Column="1" Margin="0,0,8,0">
                                                            <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold" TextTrimming="CharacterEllipsis" FontSize="13"/>
                                                            <TextBlock Text="{Binding Serial}" FontSize="11" Foreground="#7A7A7A" Margin="0,2,0,0"/>
                                                        </StackPanel>
                                                        <Border Grid.Column="2" Padding="8,4" CornerRadius="12" Background="{Binding StateColor}">
                                                            <TextBlock Text="{Binding State}" FontSize="10" FontWeight="Medium" Foreground="White"/>
                                                        </Border>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ListView.ItemTemplate>
                                    </ListView>
                                </DockPanel>
                            </Border>

                            <GridSplitter Grid.Column="1" HorizontalAlignment="Stretch" Width="8" Background="#F2F2F7"
                                          ResizeBehavior="PreviousAndNext" ShowsPreview="True"/>

                            <!-- APK Groups (middle) -->
                            <Border Grid.Column="2" Padding="16" CornerRadius="12" Background="White"
                                    BorderThickness="1" BorderBrush="#E0E0E0" Margin="0,0,8,0">
                                <DockPanel>
                                    <StackPanel DockPanel.Dock="Top" Margin="0,0,0,16">
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                                            <TextBlock Text="Available APK Groups" FontWeight="SemiBold" FontSize="16" VerticalAlignment="Center"/>
                                            <TextBlock Text="{Binding MultiGroupInstall.GroupsSummary}" Foreground="#7A7A7A" Margin="12,0,0,0" VerticalAlignment="Center"/>
                                            <Button Content="🔄" Command="{Binding MultiGroupInstall.RefreshGroupsCommand}" 
                                                    ToolTip="Refresh Groups" Width="32" Height="32" Margin="12,0,0,0"/>
                                        </StackPanel>
                                        <Grid Margin="0,0,0,12">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBox Grid.Column="0" Text="{Binding MultiGroupInstall.GroupFilter, UpdateSourceTrigger=PropertyChanged}"
                                                     Margin="0,0,8,0" ToolTip="Filter groups..."/>
                                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                                <Button Content="Select All" Command="{Binding MultiGroupInstall.SelectAllGroupsCommand}" 
                                                        Margin="0,0,8,0"/>
                                                <Button Content="+ Add" Command="{Binding MultiGroupInstall.AddGroupCommand}" 
                                                        Style="{StaticResource AccentButtonStyle}"/>
                                            </StackPanel>
                                        </Grid>
                                    </StackPanel>

                                    <!-- WrapPanel -> kín hàng; Scroll dọc khi overflow -->
                                    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                                        <ItemsControl ItemsSource="{Binding MultiGroupInstall.Groups}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel Orientation="Horizontal" ItemWidth="280" ItemHeight="120"/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate DataType="{x:Type vm:ApkGroupViewModel}">
                                                    <Border Margin="8,6" Padding="16" Background="White"
                                                            BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="12" Width="280" Height="110">
                                                        <Grid>
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="*"/>
                                                                <RowDefinition Height="Auto"/>
                                                            </Grid.RowDefinitions>
                                                            <StackPanel Grid.Row="0">
                                                                <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="14" TextTrimming="CharacterEllipsis"/>
                                                                <TextBlock Text="{Binding GroupInfo}" Foreground="#7A7A7A" FontSize="11" Margin="0,4,0,0" TextWrapping="Wrap"/>
                                                            </StackPanel>
                                                            <Button Grid.Row="1" Content="+ Add to Queue" 
                                                                    Command="{Binding DataContext.MultiGroupInstall.AddGroupCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                    CommandParameter="{Binding}" 
                                                                    Style="{StaticResource AccentButtonStyle}" 
                                                                    HorizontalAlignment="Stretch" Margin="0,8,0,0"/>
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>
                                </DockPanel>
                            </Border>

                            <GridSplitter Grid.Column="3" HorizontalAlignment="Stretch" Width="8" Background="#F2F2F7"
                                          ResizeBehavior="PreviousAndNext" ShowsPreview="True"/>

                            <!-- Installation Queue (right) -->
                            <Border Grid.Column="4" Padding="12" CornerRadius="10" Background="White"
                                    BorderBrush="#E6E6E6" BorderThickness="1">
                                <DockPanel>
                                    <StackPanel DockPanel.Dock="Top" Margin="0,0,0,16">
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                                            <TextBlock Text="Installation Queue" FontWeight="SemiBold" FontSize="16" VerticalAlignment="Center"/>
                                            <TextBlock Text="{Binding MultiGroupInstall.QueueSummary}" Foreground="#7A7A7A" Margin="12,0,0,0" VerticalAlignment="Center"/>
                                        </StackPanel>
                                        <Button Content="🗑️ Clear Queue" Command="{Binding MultiGroupInstall.ClearQueueCommand}" 
                                                ToolTip="Clear all items from queue" HorizontalAlignment="Left"/>
                                    </StackPanel>

                                    <ListBox ItemsSource="{Binding MultiGroupInstall.Queue}"
                                             ScrollViewer.CanContentScroll="True"
                                             VirtualizingStackPanel.IsVirtualizing="True"
                                             VirtualizingStackPanel.VirtualizationMode="Recycling"
                                             Background="#FAFAFA" BorderThickness="1" BorderBrush="#E0E0E0"
                                             AllowDrop="True">
                                        <ListBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding}" Margin="4"/>
                                            </DataTemplate>
                                        </ListBox.ItemTemplate>
                                    </ListBox>
                                </DockPanel>
                            </Border>
                        </Grid>

                        <!-- Bottom: Install Log (replacing progress bar) -->
                        <Grid Grid.Row="2">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="220"/>
                            </Grid.RowDefinitions>

                            <DockPanel Grid.Row="0" Margin="16,0,16,8">
                                <TextBlock Text="Install Log" FontWeight="SemiBold" FontSize="16" VerticalAlignment="Center"/>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                    <Button Content="📋 Copy" Command="{Binding MultiGroupInstall.CopyLogCommand}" 
                                            Margin="0,0,8,0" MinWidth="70"/>
                                    <Button Content="🗑️ Clear" Command="{Binding MultiGroupInstall.ClearLogCommand}" 
                                            MinWidth="70"/>
                                </StackPanel>
                            </DockPanel>

                            <GridSplitter Grid.Row="0" Height="6" HorizontalAlignment="Stretch" Background="#F2F2F7"
                                          ResizeDirection="Rows" ShowsPreview="True"/>

                            <Border Grid.Row="1" Margin="16" Padding="8" CornerRadius="8" Background="White"
                                    BorderBrush="#E6E6E6" BorderThickness="1">
                                <ListBox ItemsSource="{Binding MultiGroupInstall.LogLines}"
                                         xmlns:behaviors="clr-namespace:AdbInstallerApp.Behaviors"
                                         behaviors:AutoScrollBehavior.IsEnabled="True"
                                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                                         VirtualizingStackPanel.IsVirtualizing="True"
                                         VirtualizingStackPanel.VirtualizationMode="Recycling">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding}" FontFamily="Consolas" FontSize="12"/>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                            </Border>
                        </Grid>
                    </Grid>
                </Grid>
                
                <!-- Other modules can be added here with similar structure -->
            </Grid>
        </Border>
        </Grid>
        
        <!-- Bottom Status Bar with Centralized Progress -->
        <Border Grid.Row="2" 
                Background="White" 
                BorderBrush="{StaticResource DividerBrush}" 
                BorderThickness="0,1,0,0"
                Padding="20,12">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- Main Status Row -->
                <Grid Grid.Row="0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Status Text and Progress Info -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                        <!-- Normal Status (when no operation) -->
                        <TextBlock Text="{Binding StatusBarText, FallbackValue='Ready'}" 
                                   VerticalAlignment="Center" 
                                   Foreground="#666"
                                   Visibility="{Binding CentralProgress.IsOperationInProgress, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Invert}"/>
                        
                        <!-- Progress Status (when operation in progress) -->
                        <StackPanel Orientation="Horizontal" 
                                    Visibility="{Binding CentralProgress.IsOperationInProgress, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <!-- Operation Icon -->
                            <TextBlock Text="⚡" FontSize="16" VerticalAlignment="Center" Margin="0,0,8,0" 
                                       Foreground="#2196F3"/>
                            
                            <!-- Operation Name -->
                            <TextBlock Text="{Binding CentralProgress.CurrentOperationName}" 
                                       FontWeight="Medium" VerticalAlignment="Center" 
                                       Foreground="#333" Margin="0,0,8,0"/>
                            
                            <!-- Progress Percentage -->
                            <TextBlock Text="{Binding CentralProgress.CurrentProgress, StringFormat='{}{0:F1}%'}" 
                                       FontWeight="Bold" VerticalAlignment="Center" 
                                       Foreground="#2196F3" Margin="0,0,8,0"/>
                            
                            <!-- ETA (if available) -->
                            <TextBlock Text="{Binding CentralProgress.EstimatedTimeRemaining, StringFormat='ETA: {0}'}" 
                                       VerticalAlignment="Center" Foreground="#666" 
                                       Visibility="{Binding CentralProgress.EstimatedTimeRemaining, Converter={StaticResource StringToVisibilityConverter}}"/>
                        </StackPanel>
                    </StackPanel>
                    
                    <!-- Action Buttons -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <Button Content="🔄 Refresh All" 
                                Style="{StaticResource ModernButtonStyle}"
                                Command="{Binding RefreshAllCommand}"
                                Margin="0,0,8,0" Padding="12,6"
                                IsEnabled="{Binding CentralProgress.IsOperationInProgress, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Invert}"/>
                        <Button Content="📊 Status" 
                                Style="{StaticResource ModernButtonStyle}"
                                Command="{Binding ShowStatusCommand}"
                                Margin="0,0,8,0" Padding="12,6"/>
                        <Button Content="? Help" 
                                Style="{StaticResource ModernButtonStyle}"
                                Command="{Binding ShowHelpCommand}"
                                Padding="12,6"/>
                    </StackPanel>
                </Grid>
                
                <!-- Progress Bar Row (only visible during operations) -->
                <!-- 
                <Grid Grid.Row="1" Margin="0,8,0,0"
                      Visibility="{Binding CentralProgress.IsOperationInProgress, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    Progress Bar
                    <ProgressBar Grid.Column="0" 
                                 Value="{Binding CentralProgress.CurrentProgress}" 
                                 Maximum="100" Height="6" 
                                 Background="#E0E0E0" 
                                 Foreground="#4CAF50"
                                 ToolTip="{Binding CentralProgress.DetailedProgressInfo}"/>
                    
                    Processing Speed
                    <TextBlock Grid.Column="1" 
                               Text="{Binding CentralProgress.ProcessingSpeed}" 
                               FontSize="11" Foreground="#888" 
                               VerticalAlignment="Center" Margin="12,0,0,0"
                               Visibility="{Binding CentralProgress.ProcessingSpeed, Converter={StaticResource StringToVisibilityConverter}}"/>
                </Grid>
                -->
                
                <!-- Operation Detail (small text below progress bar) -->
            </Grid>
        </Border>
    </Grid>
</Window>