<Window x:Class="AdbInstallerApp.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:AdbInstallerApp.ViewModels"
        xmlns:converters="clr-namespace:AdbInstallerApp.Converters"
        mc:Ignorable="d"
        Title="ADB APK Installer" Height="780" Width="1200"
        Background="{StaticResource BackgroundBrush}"
        WindowStartupLocation="CenterScreen"
        DataContextChanged="MainWindow_DataContextChanged">
<Window.DataContext>
<vm:MainViewModel/>
</Window.DataContext>


<Grid Margin="20">
<Grid.RowDefinitions>
<RowDefinition Height="Auto"/>
<RowDefinition Height="*"/>
<RowDefinition Height="200"/>
</Grid.RowDefinitions>

<!-- Header Section -->
<Border Background="{StaticResource SurfaceBrush}" 
        CornerRadius="8" 
        Padding="20" 
        Margin="0,0,0,16"
        BorderBrush="{StaticResource DividerBrush}"
        BorderThickness="1">
    <StackPanel>
        <!-- Title -->
        <TextBlock Text="ðŸ“± ADB APK Installer" 
                   FontSize="24" 
                   FontWeight="Bold" 
                   Foreground="{StaticResource TextPrimaryBrush}"
                   Margin="0,0,0,16"/>
        
        <!-- Toolbar -->
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            
            <!-- Folder Selection Row -->
            <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                <Button Content="ðŸ“ Choose APK Folder" 
                        Style="{StaticResource ModernButtonStyle}"
                        Command="{Binding ChooseRepoCommand}" 
                        Margin="0,0,12,0"/>
                <TextBox Text="{Binding ApkRepoPath}" 
                         Style="{StaticResource ModernTextBoxStyle}"
                         IsReadOnly="True" 
                         Width="450" 
                         VerticalAlignment="Center"
                         Margin="0,0,12,0"/>
                <Button Content="ðŸ”„ Rescan"
                        Style="{StaticResource ModernButtonStyle}"
                        Command="{Binding RefreshRepoCommand}"/>
            </StackPanel>
            
            <!-- Options and Install Row -->
            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                         <ColumnDefinition Width="Auto"/>
                         <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <CheckBox Content="Reinstall (-r)" 
                              IsChecked="{Binding OptReinstall}" 
                              Margin="0,0,16,0"
                              VerticalAlignment="Center"/>
                    <CheckBox Content="Grant Permissions (-g)" 
                              IsChecked="{Binding OptGrantPerms}" 
                              Margin="0,0,16,0"
                              VerticalAlignment="Center"/>
                    <CheckBox Content="Allow Downgrade (-d)" 
                              IsChecked="{Binding OptDowngrade}"
                              Margin="0,0,16,0"
                              VerticalAlignment="Center"/>
                    <CheckBox Content="Parallel Install" 
                              IsChecked="{Binding EnableParallelInstall}"
                              Margin="0,0,16,0"
                              VerticalAlignment="Center"/>
                </StackPanel>
                
                <ToggleButton Grid.Column="1" 
                             Content="ðŸ“ Group View" 
                             IsChecked="{Binding IsGroupViewEnabled}"
                             Style="{StaticResource ModernToggleButtonStyle}"
                             Margin="0,0,12,0"
                             Padding="12,8"/>
                
                                                  <Button Grid.Column="2" 
                         Content="âš¡ Install on Selected Devices" 
                         Style="{StaticResource AccentButtonStyle}"
                         Command="{Binding InstallOnSelectedCommand}"
                         FontSize="14"
                          Padding="20,10"
                          Margin="0,0,12,0"
                          ToolTip="{Binding InstallButtonTooltip}"/>
                 
                 <Button Grid.Column="3" 
                         Content="âš™ï¸ Settings" 
                         Style="{StaticResource ModernButtonStyle}"
                         Click="Settings_Click"
                         FontSize="12"
                         Padding="12,8"/>
            </Grid>
        </Grid>
    </StackPanel>
</Border>


<!-- Content Area -->
<Grid Grid.Row="1" Margin="0,0,0,16">
<Grid.ColumnDefinitions>
<ColumnDefinition Width="2*"/>
<ColumnDefinition Width="12"/>
<ColumnDefinition Width="2*"/>
<ColumnDefinition Width="12"/>
<ColumnDefinition Width="2*"/>
</Grid.ColumnDefinitions>

<!-- Devices Section -->
<GroupBox Header="ðŸ“± Connected Devices (Real-time)" 
          Style="{StaticResource ModernGroupBoxStyle}">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        
        <StackPanel Grid.Row="0" Margin="0,0,0,8">
            <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                <TextBlock Text="Select devices to install APKs â€¢ Click â„¹ï¸ for USB Debug help" 
                           Foreground="{StaticResource TextSecondaryBrush}"
                           VerticalAlignment="Center"/>
                <Button Content="ðŸ”„ Refresh Devices" 
                        Style="{StaticResource ModernButtonStyle}"
                        Command="{Binding RefreshDevicesCommand}"
                        Padding="8,4"
                        FontSize="11"
                        Margin="16,0,0,0"/>
            </StackPanel>
            <TextBlock Text="{Binding DeviceStatusSummary}" 
                   Foreground="{StaticResource TextSecondaryBrush}"
                       FontSize="11"/>
        </StackPanel>
        
        <DataGrid Grid.Row="1" 
                  ItemsSource="{Binding Devices}" 
                  AutoGenerateColumns="False" 
                  CanUserAddRows="False"
                  CanUserDeleteRows="False"
                  CanUserResizeRows="False"
                  GridLinesVisibility="Horizontal"
                  HeadersVisibility="Column"
                  SelectionMode="Single"
                  Background="{StaticResource SurfaceBrush}"
                  RowBackground="{StaticResource SurfaceBrush}"
                  AlternatingRowBackground="#F8F9FA">
            <DataGrid.Columns>
                <DataGridCheckBoxColumn Binding="{Binding IsSelected}" 
                                        Header="âœ“" 
                                        Width="40"/>
                <DataGridTextColumn Binding="{Binding DisplayName}" 
                                    Header="Device" 
                                    Width="160"
                                    IsReadOnly="True"/>
                <DataGridTextColumn Binding="{Binding DeviceInfo}" 
                                    Header="Android Info" 
                                    Width="100"
                                    IsReadOnly="True"/>
                <DataGridTextColumn Binding="{Binding RootStatus}" 
                                    Header="Root" 
                                    Width="70"
                                    IsReadOnly="True"/>
                <DataGridTextColumn Binding="{Binding Architecture}" 
                                    Header="Arch" 
                                    Width="60"
                                    IsReadOnly="True"/>
                <DataGridTextColumn Binding="{Binding BuildInfo}" 
                                    Header="Build" 
                                    Width="80"
                                    IsReadOnly="True"/>
                <DataGridTextColumn Binding="{Binding State}" 
                                    Header="Status" 
                                    Width="70"
                                    IsReadOnly="True"/>
                <DataGridTemplateColumn Header="Debug Status" Width="100">
                    <DataGridTemplateColumn.HeaderStyle>
                        <Style TargetType="DataGridColumnHeader">
                            <Setter Property="ToolTip" Value="USB Debug connection status and troubleshooting help"/>
                        </Style>
                    </DataGridTemplateColumn.HeaderStyle>
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" Margin="4">
                                <TextBlock Text="{Binding DebugStatusIcon}" 
                                           FontSize="16" 
                                           VerticalAlignment="Center"
                                           Margin="0,0,4,0"
                                           ToolTip="{Binding DebugStatusText}"/>
                                <Button Content="â„¹ï¸" 
                                        Style="{StaticResource DebugInfoButtonStyle}"
                                        Command="{Binding ShowDebugHelpCommand}"
                                        ToolTip="Click for troubleshooting help"
                                        Margin="4,0,0,0"/>
                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>
    </Grid>
</GroupBox>

<!-- APK Repository Section -->
<GroupBox Grid.Column="2" 
          Header="ðŸ“¦ APK Files" 
          Style="{StaticResource ModernGroupBoxStyle}">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        
        <StackPanel Grid.Row="0" Margin="0,0,0,8">
            <TextBlock Text="Select individual APK files to install" 
                   Foreground="{StaticResource TextSecondaryBrush}"
                   Margin="0,0,0,8"/>
            <StackPanel Orientation="Horizontal">
                <Button Content="âš¡ Quick Install" 
                        Style="{StaticResource ModernButtonStyle}"
                        Command="{Binding QuickInstallCommand}"
                        Padding="8,4"
                        FontSize="11"
                        Margin="0,0,8,0"/>
                <Button Content="ðŸ“‹ Select All" 
                        Style="{StaticResource ModernButtonStyle}"
                        Command="{Binding SelectAllApksCommand}"
                        Padding="8,4"
                        FontSize="11"
                        Margin="0,0,8,0"/>
                <Button Content="âŒ Clear Selection" 
                        Style="{StaticResource ModernButtonStyle}"
                        Command="{Binding ClearApkSelectionCommand}"
                        Padding="8,4"
                        FontSize="11"/>
            </StackPanel>
        </StackPanel>
        
        <!-- List View -->
        <DataGrid Grid.Row="1" 
                  ItemsSource="{Binding ApkFiles}" 
                  AutoGenerateColumns="False" 
                  CanUserAddRows="False"
                  CanUserDeleteRows="False"
                  CanUserResizeRows="False"
                  GridLinesVisibility="Horizontal"
                  HeadersVisibility="Column"
                  SelectionMode="Single"
                  Background="{StaticResource SurfaceBrush}"
                  RowBackground="{StaticResource SurfaceBrush}"
                  AlternatingRowBackground="#F8F9FA"
                  Visibility="{Binding IsGroupViewEnabled, Converter={StaticResource InverseBooleanToVisibilityConverter}}"
                  AllowDrop="True"
                  Drop="DataGrid_Drop"
                  DragOver="DataGrid_DragOver"
                  MouseMove="DataGrid_MouseMove">
            <DataGrid.ContextMenu>
                <ContextMenu Style="{StaticResource ModernContextMenuStyle}">
                    <MenuItem Header="ðŸ“ Add to Group" Command="{Binding AddToGroupCommand}" Style="{StaticResource ModernMenuItemStyle}"/>
                    <MenuItem Header="âš¡ Quick Install" Command="{Binding QuickInstallCommand}" Style="{StaticResource ModernMenuItemStyle}"/>
                    <Separator/>
                    <MenuItem Header="ðŸ“‹ Select All" Command="{Binding SelectAllApksCommand}" Style="{StaticResource ModernMenuItemStyle}"/>
                    <MenuItem Header="âŒ Clear Selection" Command="{Binding ClearApkSelectionCommand}" Style="{StaticResource ModernMenuItemStyle}"/>
                </ContextMenu>
            </DataGrid.ContextMenu>
            <DataGrid.Columns>
                <DataGridCheckBoxColumn Binding="{Binding IsSelected}" 
                                        Header="âœ“" 
                                        Width="40"/>
                <DataGridTextColumn Binding="{Binding DisplayInfo}" 
                                    Header="APK Info" 
                                    Width="180"
                                    IsReadOnly="True"/>
                <DataGridTextColumn Binding="{Binding VersionInfo}" 
                                    Header="Version" 
                                    Width="100"
                                    IsReadOnly="True"/>
                <DataGridTextColumn Binding="{Binding FileSize}" 
                                    Header="Size" 
                                    Width="70"
                                    IsReadOnly="True"/>
                <DataGridTextColumn Binding="{Binding Type}" 
                                    Header="Type" 
                                    Width="80"
                                    IsReadOnly="True"/>
                <DataGridTextColumn Binding="{Binding SplitTag}" 
                                    Header="Split Tag" 
                                    Width="80"
                                    IsReadOnly="True"/>
            </DataGrid.Columns>
        </DataGrid>
        
        <!-- Group View -->
        <TreeView Grid.Row="1" 
                  ItemsSource="{Binding ApkGroups}" 
                  Visibility="{Binding IsGroupViewEnabled, Converter={StaticResource BooleanToVisibilityConverter}}"
                  Background="{StaticResource SurfaceBrush}"
                  AllowDrop="True"
                  Drop="TreeView_Drop"
                  DragOver="TreeView_DragOver">
            <TreeView.ContextMenu>
                <ContextMenu Style="{StaticResource ModernContextMenuStyle}">
                    <MenuItem Header="âž• Create New Group" Command="{Binding CreateApkGroupCommand}" Style="{StaticResource ModernMenuItemStyle}"/>
                    <Separator/>
                    <MenuItem Header="ðŸ“ Add APKs to Group" Command="{Binding AddToGroupCommand}" Style="{StaticResource ModernMenuItemStyle}"/>
                    <MenuItem Header="ðŸ“¤ Export All Groups" Command="{Binding ExportAllGroupsCommand}" Style="{StaticResource ModernMenuItemStyle}"/>
                    <Separator/>
                    <MenuItem Header="ðŸ—‘ï¸ Clear All Groups" Command="{Binding ClearAllGroupsCommand}" Style="{StaticResource ModernMenuItemStyle}"/>
                </ContextMenu>
            </TreeView.ContextMenu>
            <TreeView.Resources>
                <!-- ApkGroup Template -->
                <HierarchicalDataTemplate DataType="{x:Type vm:ApkGroupViewModel}" ItemsSource="{Binding Model.SplitApks}">
                    <StackPanel Orientation="Horizontal">
                        <CheckBox IsChecked="{Binding IsSelected}" Margin="0,0,8,0"/>
                        <TextBlock Text="ðŸ“±" FontSize="16" Margin="0,0,8,0"/>
                        <TextBlock Text="{Binding DisplayName}" FontWeight="Bold"/>
                        <TextBlock Text="{Binding PackageName}" Foreground="Gray" Margin="10,0"/>
                        <TextBlock Text="{Binding SizeInfo}" Foreground="Blue" Margin="10,0"/>
                    </StackPanel>
                </HierarchicalDataTemplate>
                
                                 <!-- Split APK Template -->
                 <DataTemplate DataType="{x:Type vm:ApkItemViewModel}">
                     <StackPanel Orientation="Horizontal" Margin="20,0,0,0">
                         <CheckBox IsChecked="{Binding IsSelected}" Margin="0,0,8,0"/>
                         <TextBlock Text="{Binding Type}" Margin="0,0,8,0"/>
                         <TextBlock Text="{Binding FileName}"/>
                         <TextBlock Text="{Binding FileSize}" Foreground="Gray" Margin="10,0"/>
                         <StackPanel.ContextMenu>
                             <ContextMenu Style="{StaticResource ModernContextMenuStyle}">
                                 <MenuItem Header="ðŸ“ Move to Group" Command="{Binding DataContext.MoveApkToGroupCommand, RelativeSource={RelativeSource AncestorType=TreeView}}" Style="{StaticResource ModernMenuItemStyle}"/>
                                 <MenuItem Header="âŒ Remove from Group" Command="{Binding DataContext.RemoveApkFromGroupCommand, RelativeSource={RelativeSource AncestorType=TreeView}}" Style="{StaticResource ModernMenuItemStyle}"/>
                                 <Separator/>
                                 <MenuItem Header="âš¡ Quick Install" Command="{Binding DataContext.QuickInstallCommand, RelativeSource={RelativeSource AncestorType=TreeView}}" Style="{StaticResource ModernMenuItemStyle}"/>
                             </ContextMenu>
                         </StackPanel.ContextMenu>
                     </StackPanel>
                 </DataTemplate>
            </TreeView.Resources>
        </TreeView>
    </Grid>
</GroupBox>

<!-- APK Groups Section -->
<GroupBox Grid.Column="4" 
          Header="ðŸ“¦ APK Groups" 
          Style="{StaticResource ModernGroupBoxStyle}">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        
        <StackPanel Grid.Row="0" Margin="0,0,0,8">
            <TextBlock Text="Select APK groups for smart installation" 
                       Foreground="{StaticResource TextSecondaryBrush}"
                       Margin="0,0,0,8"/>
                         <StackPanel Orientation="Horizontal">
                 <Button Content="âž• Create Group" 
                         Style="{StaticResource ModernButtonStyle}"
                         Command="{Binding CreateApkGroupCommand}"
                         Padding="8,4"
                         FontSize="11"
                         Margin="0,0,8,0"/>
                 <Button Content="ðŸ“ Add to Group" 
                         Style="{StaticResource ModernButtonStyle}"
                         Command="{Binding AddToGroupCommand}"
                         Padding="8,4"
                         FontSize="11"
                         Margin="0,0,8,0"/>
                 <Button Content="ðŸ—‘ï¸ Delete Group" 
                         Style="{StaticResource ModernButtonStyle}"
                         Command="{Binding DeleteGroupCommand}"
                         Padding="8,4"
                         FontSize="11"/>
             </StackPanel>
        </StackPanel>
        
                 <DataGrid Grid.Row="1" 
                   ItemsSource="{Binding ApkGroups}" 
                   AutoGenerateColumns="False" 
                   CanUserAddRows="False"
                   CanUserDeleteRows="False"
                   CanUserResizeRows="False"
                   GridLinesVisibility="Horizontal"
                   HeadersVisibility="Column"
                   SelectionMode="Single"
                   Background="{StaticResource SurfaceBrush}"
                   RowBackground="{StaticResource SurfaceBrush}"
                   AlternatingRowBackground="#F8F9FA"
                   RowDetailsVisibilityMode="VisibleWhenSelected">
             <DataGrid.ContextMenu>
                 <ContextMenu Style="{StaticResource ModernContextMenuStyle}">
                     <MenuItem Header="âœï¸ Edit Group" Command="{Binding EditGroupCommand}" Style="{StaticResource ModernMenuItemStyle}"/>
                     <MenuItem Header="ðŸ“ Add APKs" Command="{Binding AddToGroupCommand}" Style="{StaticResource ModernMenuItemStyle}"/>
                     <MenuItem Header="ðŸ“¤ Export Group" Command="{Binding ExportGroupCommand}" Style="{StaticResource ModernMenuItemStyle}"/>
                     <Separator/>
                     <MenuItem Header="ðŸ—‘ï¸ Delete Group" Command="{Binding DeleteGroupCommand}" Style="{StaticResource ModernMenuItemStyle}"/>
                 </ContextMenu>
             </DataGrid.ContextMenu>
             <DataGrid.Columns>
                 <DataGridCheckBoxColumn Binding="{Binding IsSelected}" 
                                         Header="âœ“" 
                                         Width="40"/>
                 <DataGridTextColumn Binding="{Binding DisplayName}" 
                                     Header="App Name" 
                                     Width="120"
                                     IsReadOnly="True"/>
                 <DataGridTextColumn Binding="{Binding VersionInfo}" 
                                     Header="Version" 
                                     Width="80"
                                     IsReadOnly="True"/>
                 <DataGridTextColumn Binding="{Binding SplitInfo}" 
                                     Header="Splits" 
                                     Width="60"
                                     IsReadOnly="True"/>
                 <DataGridTextColumn Binding="{Binding SizeInfo}" 
                                     Header="Total Size" 
                                     Width="80"
                                     IsReadOnly="True"/>
                 <DataGridTextColumn Binding="{Binding CompatibilityText}" 
                                     Header="Compatibility" 
                                     Width="100"
                                     IsReadOnly="True"/>
             </DataGrid.Columns>
             
             <!-- Row Details Template to show split APKs -->
             <DataGrid.RowDetailsTemplate>
                 <DataTemplate>
                     <Border Background="#F0F0F0" Margin="40,0,0,0" Padding="8">
                         <StackPanel>
                             <TextBlock Text="ðŸ“¦ Split APKs in this group:" 
                                        FontWeight="SemiBold" 
                                        Margin="0,0,0,8"
                                        Foreground="#666"/>
                             <ItemsControl ItemsSource="{Binding Model.SplitApks}">
                                 <ItemsControl.ItemTemplate>
                                     <DataTemplate>
                                         <StackPanel Orientation="Horizontal" Margin="0,2">
                                             <TextBlock Text="â€¢" Margin="0,0,8,0" Foreground="#999"/>
                                             <TextBlock Text="{Binding FileName}" FontWeight="Normal"/>
                                             <TextBlock Text="(" Foreground="#999"/>
                                             <TextBlock Text="{Binding Type}" Foreground="#666"/>
                                             <TextBlock Text=")" Foreground="#999"/>
                                             <TextBlock Text=" - " Foreground="#999"/>
                                             <TextBlock Text="{Binding FileSize}" Foreground="#666"/>
                                         </StackPanel>
                                     </DataTemplate>
                                 </ItemsControl.ItemTemplate>
                             </ItemsControl>
                         </StackPanel>
                     </Border>
                 </DataTemplate>
             </DataGrid.RowDetailsTemplate>
         </DataGrid>
    </Grid>
</GroupBox>
</Grid>


<!-- Log Section -->
<GroupBox Grid.Row="2" 
          Header="ðŸ“„ Installation Log" 
          Style="{StaticResource ModernGroupBoxStyle}">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        
        <StackPanel Grid.Row="0" 
                    Orientation="Horizontal" 
                    Margin="0,0,0,8">
            <TextBlock Text="Real-time installation progress and logs" 
                       Foreground="{StaticResource TextSecondaryBrush}"
                       VerticalAlignment="Center"/>
            <Button Content="ðŸ—‘ï¸ Clear" 
                    Style="{StaticResource ModernButtonStyle}"
                    Padding="8,4"
                    FontSize="11"
                    Margin="16,0,0,0"
                    Click="ClearLog_Click"/>
        </StackPanel>
        
                <Border Grid.Row="1" 
                 Background="#1E1E1E" 
                 CornerRadius="4" 
                 BorderBrush="{StaticResource DividerBrush}"
                 BorderThickness="1">
            <ScrollViewer x:Name="LogScrollViewer" 
                          VerticalScrollBarVisibility="Auto" 
                          HorizontalScrollBarVisibility="Auto"
                          Padding="12">
                <TextBox Text="{Binding LogText}" 
                         Background="Transparent"
                         Foreground="#FFFFFF"
                         FontFamily="Consolas" 
                         FontSize="12"
                         TextWrapping="NoWrap" 
                         AcceptsReturn="True" 
                         BorderThickness="0"
                         IsReadOnly="True"
                         VerticalScrollBarVisibility="Disabled"
                         HorizontalScrollBarVisibility="Disabled"/>
            </ScrollViewer>
        </Border>
    </Grid>
</GroupBox>
</Grid>
</Window>