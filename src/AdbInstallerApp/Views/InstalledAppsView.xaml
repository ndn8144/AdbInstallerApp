<UserControl x:Class="AdbInstallerApp.Views.InstalledAppsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:AdbInstallerApp.ViewModels"
             xmlns:models="clr-namespace:AdbInstallerApp.Models"
             xmlns:converters="clr-namespace:AdbInstallerApp.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="1200">
    
    <UserControl.Resources>
        <converters:AppFilterTypeConverter x:Key="AppFilterTypeConverter"/>
    </UserControl.Resources>

    <Grid Background="{StaticResource BackgroundBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="200"/>
        </Grid.RowDefinitions>

        <!-- Header Section -->
        <Border Grid.Row="0" Background="{StaticResource SurfaceBrush}" 
                BorderBrush="{StaticResource DividerBrush}" BorderThickness="0,0,0,1"
                Padding="20,15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0" Orientation="Vertical">
                    <TextBlock Text="Installed Apps" 
                               FontSize="24" FontWeight="Bold" 
                               FontFamily="{StaticResource SrotoneBold}"
                               Foreground="{StaticResource TextPrimaryBrush}"/>
                    <TextBlock Text="{Binding StatusMessage}" 
                               FontSize="14" 
                               Foreground="{StaticResource TextSecondaryBrush}"
                               Margin="0,5,0,0"/>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="{Binding TotalAppsCount, StringFormat='Total: {0}'}" 
                               FontSize="14" FontWeight="Medium"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               Margin="0,0,15,0"/>
                    <TextBlock Text="{Binding SelectedAppsCount, StringFormat='Selected: {0}'}" 
                               FontSize="14" FontWeight="Medium"
                               Foreground="{StaticResource PrimaryBrush}"
                               Margin="0,0,15,0"/>
                    <Button Content="Refresh" 
                            Command="{Binding RefreshAppsCommand}"
                            Style="{StaticResource ModernButtonStyle}"
                            Margin="5,0"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Filter and Control Section -->
        <Border Grid.Row="1" Background="{StaticResource SurfaceBrush}" 
                BorderBrush="{StaticResource DividerBrush}" BorderThickness="0,0,0,1"
                Padding="20,15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Search and Filter Controls -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <!-- Search Box -->
                    <TextBox Text="{Binding SearchKeyword, UpdateSourceTrigger=PropertyChanged}" 
                             Width="250" Height="35"
                             Style="{StaticResource ModernTextBoxStyle}"
                             FontSize="14"
                             VerticalContentAlignment="Center"
                             Margin="0,0,15,0">
                        <TextBox.Template>
                            <ControlTemplate TargetType="TextBox">
                                <Border Background="{TemplateBinding Background}" 
                                        BorderBrush="{TemplateBinding BorderBrush}" 
                                        BorderThickness="{TemplateBinding BorderThickness}"
                                        CornerRadius="4">
                                    <Grid>
                                        <ScrollViewer x:Name="PART_ContentHost" 
                                                    Margin="10,0,30,0"
                                                    VerticalAlignment="Center"/>
                                        <TextBlock Text="ðŸ” Search apps..." 
                                                 Foreground="{StaticResource TextSecondaryBrush}"
                                                 Margin="10,0,0,0"
                                                 VerticalAlignment="Center"
                                                 IsHitTestVisible="False"
                                                 Visibility="{Binding Text, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource StringToVisibilityConverter}, ConverterParameter=Invert}"/>
                                    </Grid>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsFocused" Value="True">
                                        <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrush}"/>
                                        <Setter Property="BorderThickness" Value="2"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </TextBox.Template>
                    </TextBox>

                    <!-- App Type Filter -->
                    <ComboBox SelectedIndex="0" Width="150" Height="35"
                              FontSize="14" Margin="0,0,15,0">
                        <ComboBoxItem Content="All Apps" Tag="All"/>
                        <ComboBoxItem Content="User Apps" Tag="UserApps"/>
                        <ComboBoxItem Content="System Apps" Tag="SystemApps"/>
                    </ComboBox>

                    <!-- Include Splits Checkbox -->
                    <CheckBox IsChecked="{Binding IncludeSplits}" 
                              Content="Include Splits" 
                              FontSize="14" 
                              VerticalAlignment="Center"
                              Margin="0,0,15,0"/>
                </StackPanel>

                <!-- Selection Controls -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,15,0">
                    <Button Content="Select All" 
                            Command="{Binding SelectAllCommand}"
                            Style="{StaticResource ModernButtonStyle}"
                            Margin="0,0,5,0"/>
                    <Button Content="Deselect All" 
                            Command="{Binding DeselectAllCommand}"
                            Style="{StaticResource ModernButtonStyle}"
                            Margin="5,0,0,0"/>
                </StackPanel>

                <!-- Export Controls -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button Content="Export Selected" 
                            Command="{Binding ExportSelectedAppsCommand}"
                            Style="{StaticResource AccentButtonStyle}"
                            Margin="0,0,5,0"/>
                    <Button Content="Export All Filtered" 
                            Command="{Binding ExportAllFilteredAppsCommand}"
                            Style="{StaticResource ModernButtonStyle}"
                            Margin="5,0,0,0"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Apps DataGrid -->
        <Border Grid.Row="2" Background="{StaticResource SurfaceBrush}" 
                BorderBrush="{StaticResource DividerBrush}" BorderThickness="0,0,0,1"
                Margin="10">
            <Grid>
                <!-- Loading Overlay -->
                <Border Background="#80FFFFFF" 
                        Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
                        Panel.ZIndex="100">
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                        <ProgressBar IsIndeterminate="True" Width="200" Height="4" 
                                   Foreground="{StaticResource PrimaryBrush}"/>
                        <TextBlock Text="Loading installed apps..." 
                                 FontSize="16" FontWeight="Medium"
                                 Foreground="{StaticResource TextPrimaryBrush}"
                                 HorizontalAlignment="Center" Margin="0,15,0,0"/>
                        <Button Content="Cancel" 
                              Command="{Binding CancelLoadCommand}"
                              Style="{StaticResource ModernButtonStyle}"
                              Margin="0,10,0,0"/>
                    </StackPanel>
                </Border>

                <!-- Exporting Overlay -->
                <Border Background="#80FFFFFF" 
                        Visibility="{Binding IsExporting, Converter={StaticResource BooleanToVisibilityConverter}}"
                        Panel.ZIndex="100">
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Width="350">
                        <!-- Export Progress Bar -->
                        <ProgressBar Value="{Binding ExportProgress}" 
                                   Maximum="100" 
                                   Width="300" Height="8" 
                                   Foreground="{StaticResource AccentBrush}"
                                   Background="#E0E0E0"
                                   BorderThickness="1"
                                   BorderBrush="{StaticResource DividerBrush}"/>
                        
                        <!-- Progress Text -->
                        <TextBlock Text="{Binding ExportStatusText}" 
                                 FontSize="16" FontWeight="Medium"
                                 Foreground="{StaticResource TextPrimaryBrush}"
                                 HorizontalAlignment="Center" 
                                 TextAlignment="Center"
                                 Margin="0,15,0,0"/>
                        
                        <!-- Progress Details -->
                        <TextBlock Text="{Binding ExportProgressText}" 
                                 FontSize="12" 
                                 Foreground="{StaticResource TextSecondaryBrush}"
                                 HorizontalAlignment="Center" 
                                 TextAlignment="Center"
                                 Margin="0,5,0,0"/>
                        
                        <!-- Current File -->
                        <TextBlock Text="{Binding CurrentExportFile}" 
                                 FontSize="11" 
                                 Foreground="{StaticResource TextSecondaryBrush}"
                                 HorizontalAlignment="Center" 
                                 TextAlignment="Center"
                                 TextTrimming="CharacterEllipsis"
                                 MaxWidth="280"
                                 Margin="0,5,0,15"/>
                        
                        <Button Content="Cancel Export" 
                              Command="{Binding CancelExportCommand}"
                              Style="{StaticResource AccentButtonStyle}"
                              Margin="0,10,0,0"/>
                    </StackPanel>
                </Border>

                <!-- Apps List -->
                <DataGrid ItemsSource="{Binding FilteredInstalledApps}" 
                          AutoGenerateColumns="False"
                          CanUserAddRows="False" CanUserDeleteRows="False"
                          CanUserResizeRows="False" CanUserSortColumns="True"
                          GridLinesVisibility="Horizontal"
                          HeadersVisibility="Column"
                          SelectionMode="Extended"
                          SelectionUnit="FullRow"
                          RowStyle="{StaticResource ModernDataGridRowStyle}"
                          ColumnHeaderStyle="{StaticResource ModernDataGridHeaderStyle}"
                          CellStyle="{StaticResource ModernDataGridCellStyle}"
                          Background="Transparent"
                          BorderThickness="0"
                          AlternatingRowBackground="{StaticResource DeviceAlternateColor}"
                          RowHeight="40">
                    
                    <DataGrid.Columns>
                        <!-- Selection Column -->
                        <DataGridTemplateColumn Header="Select" Width="70" CanUserSort="False" CanUserResize="False">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <CheckBox IsChecked="{Binding IsSelected, UpdateSourceTrigger=PropertyChanged}" 
                                            HorizontalAlignment="Center" VerticalAlignment="Center"
                                            Style="{StaticResource ModernDataGridCheckBoxStyle}"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <!-- App Name Column -->
                        <DataGridTextColumn Header="App Name" Binding="{Binding DisplayName}" 
                                          Width="2*" MinWidth="180" MaxWidth="300">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="FontWeight" Value="Medium"/>
                                    <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
                                    <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
                                    <Setter Property="ToolTip" Value="{Binding DisplayName}"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Package Name Column -->
                        <DataGridTextColumn Header="Package Name" Binding="{Binding PackageName}" 
                                          Width="2*" MinWidth="200" MaxWidth="350">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="FontFamily" Value="Consolas"/>
                                    <Setter Property="FontSize" Value="12"/>
                                    <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
                                    <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
                                    <Setter Property="ToolTip" Value="{Binding PackageName}"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Version Column -->
                        <DataGridTextColumn Header="Version" Binding="{Binding VersionInfo}" 
                                          Width="100" MinWidth="80" MaxWidth="120">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                    <Setter Property="FontFamily" Value="Consolas"/>
                                    <Setter Property="FontSize" Value="12"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Type Column -->
                        <DataGridTextColumn Header="Type" Binding="{Binding AppType}" 
                                          Width="80" MinWidth="70" MaxWidth="90">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                    <Setter Property="FontWeight" Value="Medium"/>
                                    <Setter Property="FontSize" Value="12"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Size Column -->
                        <DataGridTextColumn Header="Size" Binding="{Binding SizeInfo}" 
                                          Width="100" MinWidth="80" MaxWidth="120">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="HorizontalAlignment" Value="Right"/>
                                    <Setter Property="FontFamily" Value="Consolas"/>
                                    <Setter Property="FontSize" Value="12"/>
                                    <Setter Property="Margin" Value="0,0,10,0"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Splits Column -->
                        <DataGridTextColumn Header="Splits" Binding="{Binding SplitInfo}" 
                                          Width="80" MinWidth="70" MaxWidth="90">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                    <Setter Property="FontSize" Value="12"/>
                                    <Setter Property="Foreground" Value="{StaticResource AccentBrush}"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Border>

        <!-- Status Bar -->
        <Border Grid.Row="3" Background="{StaticResource DeviceHeaderColor}" 
                BorderBrush="{StaticResource DividerBrush}" BorderThickness="0,1,0,0"
                Padding="20,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <TextBlock Grid.Column="0" Text="{Binding StatusMessage}" 
                         FontSize="14" 
                         Foreground="{StaticResource TextSecondaryBrush}"
                         VerticalAlignment="Center"/>
                
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="{Binding FilteredInstalledApps.Count, StringFormat='Showing: {0}'}" 
                             FontSize="14" FontWeight="Medium"
                             Foreground="{StaticResource TextSecondaryBrush}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Log Section -->
        <GroupBox Grid.Row="4" Header="Export Log" 
                  Style="{StaticResource ModernGroupBoxStyle}"
                  Margin="10,0,10,10">
            <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
                <TextBox Text="{Binding ExportLog}" 
                         IsReadOnly="True"
                         Background="Transparent"
                         BorderThickness="0"
                         FontFamily="Consolas"
                         FontSize="12"
                         TextWrapping="Wrap"
                         AcceptsReturn="True"
                         VerticalScrollBarVisibility="Auto"/>
            </ScrollViewer>
        </GroupBox>
    </Grid>
</UserControl>
